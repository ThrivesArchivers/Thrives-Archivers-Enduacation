<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multi-User Meeting</title>
<style>
body, html { margin:0; padding:0; font-family: Arial; background:#000; color:white; overflow:hidden; height:100%; }
#meetingContainer { display:flex; flex-direction:column; height:100%; }
#whiteboardContainer { flex:1; position:relative; background:#111; }
#canvas { width:100%; height:100%; display:block; touch-action:none; }
#toolbar { position:absolute; top:10px; left:50%; transform:translateX(-50%); background:#222; padding:10px; border-radius:8px; display:flex; flex-direction:column; gap:5px; z-index:20; }
#toolbar input, #toolbar select, #toolbar button { margin:2px; }
#participantsPanel { position:absolute; bottom:0; left:0; right:0; height:140px; background:rgba(0,0,0,0.6); display:flex; flex-wrap:wrap; gap:5px; padding:5px; }
.participantBox { width:100px; height:100px; background:rgba(255,255,255,0.1); border-radius:6px; display:flex; flex-direction:column; align-items:center; justify-content:center; font-size:0.8rem; }
#chatBox { position:absolute; right:10px; top:200px; width:250px; max-height:400px; background:rgba(0,0,0,0.6); display:flex; flex-direction:column; border-radius:8px; }
#chatMessages { flex:1; overflow-y:auto; padding:5px; }
#chatMessages .chatMsg { margin:2px 0; padding:2px 4px; border-radius:4px; background:rgba(255,255,255,0.1); font-size:0.8rem; }
#chatInput { display:flex; gap:5px; padding:5px; }
#chatInput input { flex:1; padding:4px; border-radius:4px; border:none; }
#chatInput button { padding:4px 6px; border-radius:4px; border:none; background:#444; color:white; cursor:pointer; }
#slidePanel { margin-top:10px; }
#slidePanel img { width:100%; max-height:300px; display:block; margin-top:5px; border:1px solid #444; }
#videoContainer { position:absolute; top:10px; right:300px; display:flex; flex-wrap:wrap; gap:5px; z-index:25; }
</style>
</head>
<body>

<input id="roomInput" placeholder="Enter Room ID">
<button id="joinBtn">Join Room</button>

<div id="meetingContainer" style="display:none;">
  <div id="whiteboardContainer">
    <canvas id="canvas"></canvas>
    <div id="toolbar">
      <select id="tool">
        <option value="pen">Pen</option>
        <option value="eraser">Eraser</option>
        <option value="text">Text</option>
        <option value="rectangle">Rectangle</option>
        <option value="circle">Circle</option>
      </select>
      <input type="color" id="color" value="#ffffff">
      <input type="number" id="brushSize" value="5" min="1" max="50">
      <input type="text" id="textInput" placeholder="Text" style="display:none;">
      <div>
        <button id="clearAnnotations">Clear Annotations</button>
        <button id="downloadBoard">Download</button>
      </div>

      <div id="slidePanel">
        <input type="file" id="slideUpload" accept="image/*" multiple>
        <div>
          <button id="prevSlide">Previous Slide</button>
          <button id="nextSlide">Next Slide</button>
          <span id="slideCounter">0 / 0</span>
        </div>
        <img id="currentSlide" src="">
      </div>
    </div>

    <div id="participantsPanel"></div>
    <div id="chatBox">
      <div id="chatMessages"></div>
      <div id="chatInput">
        <input id="chatText" placeholder="Type message">
        <button id="sendChat">Send</button>
      </div>
    </div>
    <div id="videoContainer"></div>
  </div>
</div>

<script>
let roomID, myName="User"+Math.floor(Math.random()*10000);
let peers = {}, dataChannels = {};
let ws = new WebSocket('ws://localhost:3000');
let localStream;

// ======= Join Room =======
document.getElementById('joinBtn').onclick = async ()=>{
    roomID=document.getElementById('roomInput').value || "ROOM_"+Math.floor(Math.random()*1000);
    document.getElementById('meetingContainer').style.display="flex";

    localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    const v=document.createElement('video'); v.autoplay=true; v.muted=true; v.srcObject=localStream;
    document.getElementById('videoContainer').appendChild(v);

    ws.send(JSON.stringify({type:'join', roomID, payload:{}}));
};

// ======= Handle WebSocket Messages =======
ws.onmessage = async (msg)=>{
    const data = JSON.parse(msg.data);
    if(data.type==='new-peer'){
        const pc = createPeerConnection();
        const dc = pc.createDataChannel("data");
        setupDataChannel(dc);
        dataChannels[Date.now()] = dc;
        peers[Date.now()] = pc;

        localStream.getTracks().forEach(track=>pc.addTrack(track, localStream));
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        ws.send(JSON.stringify({type:'signal', roomID, payload:{desc:offer}}));
    } else if(data.type==='signal'){
        const pc = createPeerConnection();
        peers[Date.now()] = pc;
        localStream.getTracks().forEach(track=>pc.addTrack(track, localStream));
        await pc.setRemoteDescription(new RTCSessionDescription(data.payload.desc));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        ws.send(JSON.stringify({type:'signal', roomID, payload:{desc:answer}}));
    } else if(data.type==='annotation' || data.type==='chat' || data.type==='slide'){
        handleData(data);
    }
};

// ======= WebRTC Peer Connections =======
function createPeerConnection(){
    const pc = new RTCPeerConnection();
    pc.ontrack = e=>{
        const v=document.createElement('video'); v.srcObject=e.streams[0]; v.autoplay=true;
        document.getElementById('videoContainer').appendChild(v);
    };
    pc.ondatachannel = e=>setupDataChannel(e.channel);
    return pc;
}

function setupDataChannel(dc){
    dc.onmessage = e=>handleData(JSON.parse(e.data));
}

// ======= Broadcast function =======
function broadcast(msg){ Object.values(dataChannels).forEach(dc=>dc.send(JSON.stringify(msg))); }

// ======= Whiteboard, slides, chat =======
// (Use the same canvas, slide, chat JS code from previous example, replacing broadcast calls with above broadcast(msg))
</script>
</body>
</html>
