<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Meeting Room - Thrives Archivers</title>
<style>
body,html{margin:0;padding:0;height:100%;font-family:Arial,sans-serif;background:#000;color:white;overflow:hidden;}
#meetingContainer{display:flex;flex-direction:column;height:100%;width:100%;position:relative;}
#whiteboardContainer{flex:1;position:relative;background:#111;display:none;}
#canvas{display:block;width:100%;height:100%;touch-action:none;}
#toolbar{position:absolute;top:10px;left:50%;transform:translateX(-50%);background:#222;padding:10px;border-radius:8px;z-index:20;display:flex;flex-direction:column;gap:5px;}
#participantsPanel{position:absolute;bottom:0;left:0;right:0;height:120px;background:rgba(0,0,0,0.6);display:flex;overflow-x:auto;padding:5px;gap:5px;z-index:15;}
.participantBox{width:100px;height:100px;background:rgba(255,255,255,0.1);border-radius:6px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:0.8rem;}
#controls{position:absolute;top:10px;right:10px;z-index:20;display:flex;flex-direction:column;gap:5px;}
.btn{padding:5px 10px;border:none;border-radius:6px;cursor:pointer;background:#333;color:white;}
.btn:hover{background:#555;}
#chatBox{position:absolute;right:10px;top:200px;width:250px;max-height:400px;background:rgba(0,0,0,0.6);border-radius:8px;display:flex;flex-direction:column;}
#chatMessages{flex:1;overflow-y:auto;padding:5px;}
.chatMsg{margin:2px 0;padding:2px 4px;border-radius:4px;background:rgba(255,255,255,0.1);font-size:0.8rem;}
#chatInput{display:flex;gap:5px;padding:5px;}
#chatInput input{flex:1;padding:4px;border-radius:4px;border:none;}
#chatInput button{padding:4px 6px;border-radius:4px;border:none;background:#444;color:white;cursor:pointer;}
#zegoContainer{position:absolute;top:0;left:0;width:200px;height:150px;z-index:25;}
</style>
</head>
<body>

<div id="meetingContainer">
  <!-- Whiteboard -->
  <div id="whiteboardContainer">
    <canvas id="canvas"></canvas>
    <div id="toolbar">
      <select id="tool">
        <option value="pen">Pen</option>
        <option value="eraser">Eraser</option>
      </select>
      <input type="color" id="color" value="#ffffff">
      <input type="number" id="brushSize" value="5" min="1" max="50">
      <button id="clearBoard">Clear</button>
      <button id="downloadBoard">Download</button>
    </div>
  </div>

  <!-- Controls -->
  <div id="controls">
    <button class="btn" id="toggleWhiteboard">Open Whiteboard</button>
    <button class="btn" id="muteAll">Mute All</button>
  </div>

  <!-- Participants Panel -->
  <div id="participantsPanel"></div>

  <!-- Chat -->
  <div id="chatBox">
    <div id="chatMessages"></div>
    <div id="chatInput">
      <input type="text" id="chatText" placeholder="Type message">
      <button id="sendChat">Send</button>
    </div>
  </div>

  <!-- Zego Video -->
  <div id="zegoContainer"></div>
</div>

<script src="https://unpkg.com/@zegocloud/zego-uikit-prebuilt/zego-uikit-prebuilt.js"></script>
<script>
const appID = 493142362;
const serverSecret = "6b5c2593ac4f7d593cecc5759987da2c"; // dev only
const roomID = "THRIVES_ROOM_1";
const userID = Math.floor(Math.random()*10000)+"";
const userName = "User"+userID;

const kitToken = ZegoUIKitPrebuilt.generateKitTokenForTest(appID, serverSecret, roomID, userID, userName);
const zp = ZegoUIKitPrebuilt.create(kitToken);

let hostID = userID; // first user = host
let isHost = true; 
let whiteboardOpen = false;
let canDraw = false; // permission for non-host

// Whiteboard
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
let drawing=false, tool='pen', color='#fff', brushSize=5, startX=0, startY=0;

function drawLine(x1,y1,x2,y2,color,size,mode="pen"){
  ctx.strokeStyle=(mode==='eraser')?'#111':color;
  ctx.lineWidth=size;
  ctx.beginPath();
  ctx.moveTo(x1,y1);
  ctx.lineTo(x2,y2);
  ctx.stroke();
}

// Send Whiteboard Event
function sendWhiteboardEvent(event,data){
  zp.sendMessage(JSON.stringify({type:"WB",event,data}));
}

// Host Drawing
canvas.addEventListener("mousedown",e=>{
  if(!whiteboardOpen) return;
  if(!isHost && !canDraw) return;
  drawing=true;
  const rect=canvas.getBoundingClientRect();
  startX=e.clientX-rect.left; startY=e.clientY-rect.top;
});
canvas.addEventListener("mousemove",e=>{
  if(!drawing) return;
  const rect=canvas.getBoundingClientRect();
  const x=e.clientX-rect.left,y=e.clientY-rect.top;
  drawLine(startX,startY,x,y,color,brushSize,tool);
  if(isHost || canDraw) sendWhiteboardEvent("drawLine",{x1:startX,y1:startY,x2:x,y2:y,color,brushSize,tool});
  startX=x; startY=y;
});
canvas.addEventListener("mouseup",()=>drawing=false);
canvas.addEventListener("mouseout",()=>drawing=false);

if(isHost){
  document.getElementById("clearBoard").addEventListener("click",()=>{
    ctx.clearRect(0,0,canvas.width,canvas.height);
    sendWhiteboardEvent("clear",{});
  });
}

// Handle Whiteboard Events
function handleWhiteboardEvent(payload){
  switch(payload.event){
    case "drawLine":
      let d=payload.data;
      drawLine(d.x1,d.y1,d.x2,d.y2,d.color,d.brushSize,d.tool);
      break;
    case "clear":
      ctx.clearRect(0,0,canvas.width,canvas.height);
      break;
    case "toggleWB":
      whiteboardOpen=payload.data.open;
      document.getElementById("whiteboardContainer").style.display=whiteboardOpen?"block":"none";
      if(!isHost){ document.getElementById("toolbar").style.display="none"; }
      break;
  }
}

// Toggle Whiteboard
document.getElementById("toggleWhiteboard").addEventListener("click",()=>{
  if(!isHost) return;
  whiteboardOpen=!whiteboardOpen;
  document.getElementById("whiteboardContainer").style.display=whiteboardOpen?"block":"none";
  document.getElementById("toolbar").style.display=whiteboardOpen?"block":"none";
  sendWhiteboardEvent("toggleWB",{open:whiteboardOpen});
  document.getElementById("toggleWhiteboard").textContent=whiteboardOpen?"Close Whiteboard":"Open Whiteboard";
});

// Chat
const chatMessagesEl=document.getElementById("chatMessages");
document.getElementById("sendChat").addEventListener("click",()=>{
  const txt=document.getElementById("chatText").value.trim();
  if(txt){ 
    zp.sendMessage(JSON.stringify({type:"CHAT",user:userName,message:txt})); 
    chatMessagesEl.innerHTML+=`<div class="chatMsg">Me: ${txt}</div>`; 
    document.getElementById("chatText").value=""; 
    chatMessagesEl.scrollTop=chatMessagesEl.scrollHeight;
  }
});
document.getElementById("chatText").addEventListener("keypress",(e)=>{
  if(e.key==="Enter"){document.getElementById("sendChat").click();}
});

// Participants Panel
let participants={};
function updateParticipants(userList){
  const panel=document.getElementById("participantsPanel");
  panel.innerHTML="";
  userList.forEach(user=>{
    participants[user.userID]=user;
    const box=document.createElement("div");
    box.className="participantBox";
    box.id="p_"+user.userID;
    box.textContent=user.userName + (user.userID===hostID?' (Host)':'');
    
    if(isHost && user.userID!==hostID){
      const btn=document.createElement("button");
      btn.textContent="Allow Draw";
      btn.style.fontSize="0.7rem"; btn.style.marginTop="2px";
      btn.onclick=()=>{ zp.sendMessage(JSON.stringify({type:"DRAW_PERMISSION",userID:user.userID,allow:true})); };
      box.appendChild(btn);
    }
    panel.appendChild(box);
  });
}

// Zego Join
zp.joinRoom({
  container: document.getElementById("zegoContainer"),
  scenario:{mode:ZegoUIKitPrebuilt.VideoConference},
  sharedLinks:[{name:"Meeting Link",url:window.location.href}],
  onUserUpdate:(userList)=>{ updateParticipants(userList); },
  onMessageReceived:(msg)=>{
    try{
      const payload=JSON.parse(msg.message);
      if(payload.type==="WB") handleWhiteboardEvent(payload);
      else if(payload.type==="DRAW_PERMISSION"){
        if(payload.userID===userID){
          canDraw=payload.allow;
          alert(canDraw ? "You can now draw!" : "Draw permission revoked!");
        }
      } else if(payload.type==="CHAT"){
        chatMessagesEl.innerHTML+=`<div class="chatMsg">${payload.user}: ${payload.message}</div>`;
        chatMessagesEl.scrollTop=chatMessagesEl.scrollHeight;
      }
    } catch(e){
      console.log("Received non-JSON message:", msg.message);
    }
  }
});
</script>
</body>
</html>
