<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Meeting Room - Thrives Archivers</title>
<style>
  body, html { margin:0; padding:0; height:100%; font-family: Arial, sans-serif; background:#000; color:white; overflow:hidden; }
  #meetingContainer { display:flex; flex-direction:column; height:100%; width:100%; position:relative; }

  /* Whiteboard */
  #whiteboardContainer { flex:1; position:relative; background:#111; }
  #canvas { display:block; width:100%; height:100%; touch-action:none; }

  /* Toolbar */
  #toolbar { position:absolute; top:10px; left:50%; transform:translateX(-50%); background:#222; padding:10px; border-radius:8px; z-index:20; display:flex; flex-direction:column; gap:5px; }
  #toolbar.hidden { display:none; }
  #toolbar input, #toolbar select, #toolbar button { margin:2px; }

  /* Participants bottom panel */
  #participantsPanel { position:absolute; bottom:0; left:0; right:0; height:120px; background:rgba(0,0,0,0.6); display:flex; overflow-x:auto; padding:5px; gap:5px; z-index:15; }
  .participantBox { width:100px; height:100px; background:rgba(255,255,255,0.1); border-radius:6px; display:flex; flex-direction:column; align-items:center; justify-content:center; font-size:0.8rem; color:white; }

  /* Controls */
  #controls { position:absolute; top:10px; right:10px; z-index:20; display:flex; flex-direction:column; gap:5px; }
  .btn { padding:5px 10px; border:none; border-radius:6px; cursor:pointer; background:#333; color:white; }
  .btn:hover { background:#555; }

  /* Chat */
  #chatBox { position:absolute; right:10px; top:200px; width:250px; max-height:400px; background:rgba(0,0,0,0.6); border-radius:8px; display:flex; flex-direction:column; }
  #chatMessages { flex:1; overflow-y:auto; padding:5px; }
  #chatMessages .chatMsg { margin:2px 0; padding:2px 4px; border-radius:4px; background:rgba(255,255,255,0.1); font-size:0.8rem; }
  #chatInput { display:flex; gap:5px; padding:5px; }
  #chatInput input { flex:1; padding:4px; border-radius:4px; border:none; }
  #chatInput button { padding:4px 6px; border-radius:4px; border:none; background:#444; color:white; cursor:pointer; }
</style>
</head>
<body>

<div id="meetingContainer">
  <div id="whiteboardContainer">
    <canvas id="canvas"></canvas>
    <div id="toolbar">
      <select id="tool">
        <option value="pen">Pen</option>
        <option value="eraser">Eraser</option>
        <option value="text">Text</option>
        <option value="rectangle">Rectangle</option>
        <option value="circle">Circle</option>
      </select>
      <input type="color" id="color" value="#ffffff">
      <input type="number" id="brushSize" value="5" min="1" max="50">
      <input type="text" id="textInput" placeholder="Text" style="display:none;">
      <div>
        <button id="clearBoard">Clear</button>
        <button id="downloadBoard">Download</button>
        <button id="toggleToolbar">Hide Toolbar</button>
      </div>
    </div>

    <div id="participantsPanel"></div>

    <div id="controls">
      <button class="btn" id="allowDraw">Allow Participants Draw</button>
      <button class="btn" id="muteAll">Mute All</button>
    </div>

    <div id="chatBox">
      <div id="chatMessages"></div>
      <div id="chatInput">
        <input type="text" id="chatText" placeholder="Type message">
        <button id="sendChat">Send</button>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/@zegocloud/zego-uikit-prebuilt/zego-uikit-prebuilt.js"></script>
<script>
// ------------------ Zego Init ------------------
const appID = 493142362;
const serverSecret = "6b5c2593ac4f7d593cecc5759987da2c";
const roomID = "THRIVES_ROOM_1";
const userID = Math.floor(Math.random()*10000)+"";
const userName = "User"+userID;
const kitToken = ZegoUIKitPrebuilt.generateKitTokenForTest(appID, serverSecret, roomID, userID, userName);
const zp = ZegoUIKitPrebuilt.create(kitToken);

let hostID = userID;
let participants = {};
let canDraw = false;

// ------------------ Whiteboard ------------------
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
let drawing=false, tool='pen', color='#fff', brushSize=5, startX=0, startY=0;
let undoStack=[], redoStack=[];

// Toolbar
const toolSelect = document.getElementById('tool');
const colorPicker = document.getElementById('color');
const brushInput = document.getElementById('brushSize');
const textInput = document.getElementById('textInput');
const toolbarDiv = document.getElementById('toolbar');
const toggleToolbarBtn = document.getElementById('toggleToolbar');
const clearBtn = document.getElementById('clearBoard');
const downloadBtn = document.getElementById('downloadBoard');

toolSelect.addEventListener('change',()=>{tool=toolSelect.value;textInput.style.display=(tool==='text')?'block':'none';});
colorPicker.addEventListener('input',()=>{color=colorPicker.value;});
brushInput.addEventListener('input',()=>{brushSize=brushInput.value;});
toggleToolbarBtn.addEventListener('click',()=>{toolbarDiv.classList.toggle('hidden'); toggleToolbarBtn.textContent=(toolbarDiv.classList.contains('hidden'))?'Show Toolbar':'Hide Toolbar';});
clearBtn.addEventListener('click',()=>{ctx.clearRect(0,0,canvas.width,canvas.height);});
downloadBtn.addEventListener('click',()=>{ const link=document.createElement('a'); link.download="whiteboard.png"; link.href=canvas.toDataURL(); link.click();});

// Draw events
canvas.addEventListener('mousedown', e=>{ if(!canDraw && userID!==hostID) return; drawing=true; const rect=canvas.getBoundingClientRect(); startX=(e.clientX-rect.left); startY=(e.clientY-rect.top); });
canvas.addEventListener('mousemove', e=>{ if(!drawing) return; const rect=canvas.getBoundingClientRect(); const x=e.clientX-rect.left; const y=e.clientY-rect.top; ctx.strokeStyle=(tool==='eraser')?'#000':color; ctx.lineWidth=brushSize; ctx.beginPath(); ctx.moveTo(startX,startY); ctx.lineTo(x,y); ctx.stroke(); startX=x; startY=y; });
canvas.addEventListener('mouseup', e=>{ drawing=false; });
canvas.addEventListener('mouseout', e=>{ drawing=false; });

// ------------------ Chat ------------------
const chatMessagesEl = document.getElementById("chatMessages");
const chatInputEl = document.getElementById("chatText");
const sendChatBtn = document.getElementById("sendChat");

function addChat(msg){ const div=document.createElement("div"); div.className="chatMsg"; div.textContent=msg; chatMessagesEl.appendChild(div); chatMessagesEl.scrollTop=chatMessagesEl.scrollHeight; }

sendChatBtn.addEventListener("click",()=>{
  const text=chatInputEl.value.trim();
  if(text){ zp.sendMessage(text); addChat("Me: "+text); chatInputEl.value=""; }
});
chatInputEl.addEventListener("keypress",(e)=>{ if(e.key==="Enter"){ sendChatBtn.click(); } });

// ------------------ Participants Panel ------------------
const participantsPanel = document.getElementById("participantsPanel");
function updateParticipants(userList){
  participantsPanel.innerHTML="";
  userList.forEach(user=>{
    participants[user.userID] = user;
    const box=document.createElement("div"); box.className="participantBox"; box.id="p_"+user.userID;
    box.textContent=user.userName + (user.userID===hostID?' (Host)':'');
    participantsPanel.appendChild(box);
  });
}

// ------------------ Host Controls ------------------
const allowDrawBtn = document.getElementById("allowDraw");
allowDrawBtn.addEventListener("click",()=>{
  if(userID!==hostID) return;
  canDraw = !canDraw;
  zp.sendMessage("DRAW_PERMISSION:" + canDraw);
  allowDrawBtn.textContent = canDraw ? "Block Participants Draw" : "Allow Participants Draw";
});

const muteAllBtn = document.getElementById("muteAll");
muteAllBtn.addEventListener("click",()=>{
  if(userID!==hostID) return;
  zp.muteAllMicrophones();
});

// ------------------ Zego Join ------------------
zp.joinRoom({
  container: document.getElementById("whiteboardContainer"),
  scenario: { mode: ZegoUIKitPrebuilt.VideoConference },
  sharedLinks:[{name:"Meeting Link", url:window.location.href}],
  onUserUpdate:(userList)=>{ updateParticipants(userList); },
  onMessageReceived:(message)=>{
    if(message.message.startsWith("DRAW_PERMISSION:")){
      canDraw = (message.message.split(":")[1].trim()==='true');
    } else {
      addChat(message.user.userName+": "+message.message);
    }
  }
});
</script>

</body>
</html>
