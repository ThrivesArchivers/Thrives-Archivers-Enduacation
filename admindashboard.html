<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Thrives Archivers - Videos</title>
  <style>
    :root{
      --brand:#1976d2;--ink:#333;--bg:#f4f4f4;--card:#fff;--muted:#777;--danger:#e53935;--youtube:#FF0000;
    }
    *{box-sizing:border-box}
    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);margin:0}
    h2{background:#333;color:#fff;padding:15px;margin:0;text-align:center}
    .topbar{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px 16px;background:#222;color:#fff}
    .topbar .left{font-weight:bold}
    .topbar .right{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .pill{background:#111;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #444}
    .btn{cursor:pointer;background:var(--brand);color:#fff;border:none;border-radius:6px;padding:8px 12px}
    .btn.ghost{background:#444}
    .btn.danger{background:var(--danger)}
    .status-bar{margin:10px auto;padding:10px;font-weight:bold;text-align:center}
    .container{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:20px;padding:20px}
    .section{background:#fff;padding:15px;border-radius:12px;box-shadow:0 0 15px rgba(0,0,0,.08)}
    .section h3{margin-top:0;background:var(--brand);color:#fff;padding:10px;border-radius:6px}
    .semester-title{font-weight:bold;margin-top:10px;color:#333;font-size:14px}
    .video-card{background:#f1f1f1;padding:10px;margin:8px 0;border-radius:8px;cursor:pointer;transition:.2s;display:flex;align-items:center;justify-content:space-between;gap:8px}
    .video-card:hover{background:#e6e6e6}
    .video-player{margin:20px auto;width:92%;max-width:960px;height:540px;border-radius:12px;overflow:hidden;box-shadow:0 0 15px rgba(0,0,0,.2);background:#000}
    iframe{width:100%;height:100%;border:none}
    .login-modal,.modal-bg{display:none;position:fixed;left:0;top:0;width:100vw;height:100vh;z-index:1000}
    .modal-bg{background:rgba(0,0,0,.35)}
    .login-modal{z-index:1001;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;padding:26px;border-radius:12px;width:92%;max-width:380px;box-shadow:0 2px 18px #2224}
    .login-modal h3{margin:0 0 10px 0}
    .hint{font-size:12px;color:var(--muted)}
    .youtube-download-icon { margin-left:8px;}
  </style>
</head>
<body>
  <h2>Thrives Archivers - Videos</h2>
  <div class="topbar">
    <div class="left">Welcome, <span id="displayName">Guest</span></div>
    <div class="right">
      <span class="pill" id="subInfo">Not logged in</span>
      <button class="btn" id="loginTopBtn">Login</button>
      <button class="btn ghost" id="logoutBtn" style="display:none">Logout</button>
    </div>
  </div>
  <div class="status-bar" id="statusBar"></div>
  <!-- Login Modal -->
  <div class="modal-bg" id="modalBg"></div>
  <div class="login-modal" id="loginModal">
    <h3>Login to your account</h3>
    <div class="hint">Use your Supabase Auth email & password</div>
    <input type="email" id="loginEmail" placeholder="Your Email" required />
    <input type="password" id="loginPassword" placeholder="Your Password" required />
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
      <button class="btn" id="loginBtn">Login</button>
      <button class="btn ghost" id="closeModalBtn">Cancel</button>
    </div>
  </div>
  <div class="container" id="container"></div>
  <div class="video-player">
    <iframe id="videoFrame" src="" allowfullscreen></iframe>
  </div>
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

// --- SUPABASE CONFIG ---
const supabaseUrl = 'https://odwiqajuubcgrrqipyju.supabase.co'
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9kd2lxYWp1dWJjZ3JycWlweWp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyNzA4MjEsImV4cCI6MjA2ODg0NjgyMX0.CPyCmqvr0QIx3PJUsZkYqRR3nGzG0kHlvStj49_U24A'
const supabase = createClient(supabaseUrl, supabaseKey)

// --- CONSTANTS ---
const ADMIN_EMAIL = 'thrivesarchivers@gmail.com'

// --- ELEMENTS ---
const container = document.getElementById('container')
const videoFrame = document.getElementById('videoFrame')
const statusBar = document.getElementById('statusBar')
const loginModal = document.getElementById('loginModal')
const modalBg = document.getElementById('modalBg')
const closeModalBtn = document.getElementById('closeModalBtn')
const loginBtn = document.getElementById('loginBtn')
const loginEmail = document.getElementById('loginEmail')
const loginPassword = document.getElementById('loginPassword')
const loginTopBtn = document.getElementById('loginTopBtn')
const logoutBtn = document.getElementById('logoutBtn')
const displayNameEl = document.getElementById('displayName')
const subInfo = document.getElementById('subInfo')

// --- STATE ---
let currentUser = null
let subscription = null // row from subscription table
let allVideos = []

// --- HELPERS ---
function showLoginModal(){ loginModal.style.display = 'block'; modalBg.style.display = 'block' }
function hideLoginModal(){ loginModal.style.display = 'none'; modalBg.style.display = 'none' }
function normalizeCourses(str){
  if(!str) return []
  return str.split(',').map(s=>s.trim()).filter(Boolean)
}
function userDisplayName(user){
  const meta = user?.user_metadata || {}
  return meta.name || meta.full_name || meta.fullName || user?.email || 'User'
}
function formatStatus(){
  if(!currentUser){
    statusBar.textContent = 'Please log in to see your subscriptions and watch videos.'
    subInfo.textContent = 'Not logged in'
    displayNameEl.textContent = 'Guest'
    return
  }
  const name = userDisplayName(currentUser)
  const email = currentUser.email
  displayNameEl.textContent = name

  if(!subscription){
    statusBar.textContent = `${email} â€” You are not subscribed. Locked videos require a password.`
    subInfo.textContent = 'No active subscription'
  } else {
    const courses = subscription.courses?.trim()
    const list = courses ? normalizeCourses(courses).join(', ') : 'All'
    statusBar.textContent = `${email} â€” Subscribed: ${list}. Start: ${subscription['start date']||'-'} | End: ${subscription['end date']||'-'}`
    subInfo.textContent = `Subscribed: ${list}`
  }
}
function canAccessVideo(video){
  if(!currentUser) return false
  if(currentUser.email === ADMIN_EMAIL) return true
  if(!subscription) return false
  const courses = subscription.courses?.trim()
  if(!courses) return true // blank means ALL courses
  const allowed = new Set(normalizeCourses(courses).map(s=>s.toLowerCase()))
  return allowed.has((video.section||'').toLowerCase())
}
function passwordsFor(video){
  return (video['password list']||'').split(',').map(s=>s.trim()).filter(Boolean)
}

// --- AUTH ---
closeModalBtn.onclick = hideLoginModal
loginTopBtn.onclick = showLoginModal
logoutBtn.onclick = async ()=>{
  await supabase.auth.signOut()
  currentUser = null
  subscription = null
  logoutBtn.style.display = 'none'
  loginTopBtn.style.display = 'inline-block'
  formatStatus()
  renderVideos(allVideos)
}

loginBtn.onclick = async ()=>{
  const email = loginEmail.value.trim()
  const password = loginPassword.value.trim()
  if(!email || !password) return alert('Please enter email and password.')

  const { data, error } = await supabase.auth.signInWithPassword({ email, password })
  if(error){ alert('Login failed: '+error.message); return }
  currentUser = data.user
  hideLoginModal()
  logoutBtn.style.display = 'inline-block'
  loginTopBtn.style.display = 'none'
  await fetchSubscriptionForUser(currentUser.email)
  formatStatus()
  await fetchVideos()
}

window.addEventListener('DOMContentLoaded', async ()=>{
  const { data: { session } } = await supabase.auth.getSession()
  if(session?.user){
    currentUser = session.user
    logoutBtn.style.display = 'inline-block'
    loginTopBtn.style.display = 'none'
    await fetchSubscriptionForUser(currentUser.email)
    formatStatus()
  } else {
    formatStatus()
    showLoginModal()
  }
  await fetchVideos()
})

// --- SUBSCRIPTION (for current user) ---
async function fetchSubscriptionForUser(email){
  subscription = null
  const { data, error } = await supabase
    .from('subscription')
    .select('email, "start date", duration, "end date", courses')
    .eq('email', email.toLowerCase())
    .maybeSingle()
  if(error){ console.error(error); return }
  subscription = data || null
}

// --- FETCH VIDEOS ---
async function fetchVideos() {
  const { data, error } = await supabase
    .from('Videos')
    .select('*')
    .order('order', { ascending: true });
  if (error) {
    console.error('Error fetching videos:', error);
    statusBar.textContent = 'Failed to load videos.';
    return;
  }
  allVideos = data || [];
  renderVideos(allVideos);
}

// --- VIDEOS ---
function renderVideos(videos){
  const grouped = {}
  videos.forEach(v=>{
    const sec = v.section || 'Other'
    const sem = v.semester || 'Other'
    grouped[sec] = grouped[sec] || {}
    grouped[sec][sem] = grouped[sec][sem] || []
    grouped[sec][sem].push(v)
  })

  container.innerHTML = ''
  Object.keys(grouped).sort().forEach(section=>{
    const secDiv = document.createElement('div')
    secDiv.className = 'section'
    secDiv.innerHTML = `<h3>${section}</h3>`

    Object.keys(grouped[section]).sort().forEach(semester=>{
      const semDiv = document.createElement('div')
      semDiv.innerHTML = `<div class="semester-title">${semester}</div>`
      grouped[section][semester].forEach(video=>{
        const card = document.createElement('div')
        const unlocked = canAccessVideo(video)
        card.className = 'video-card'
        card.innerHTML = `
          <span style="display:flex; align-items:center; gap:6px;">
            ${unlocked 
              ? `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24">
                   <path fill="#FF0000" d="M23.5 6.2s-.2-1.6-.8-2.3c-.7-.8-1.5-.8-1.9-.9C17.6 2.7 12 2.7 12 2.7h-.1s-5.6 0-8.8.3c-.4.1-1.2.1-1.9.9-.6.7-.8 2.3-.8 2.3S0 8.2 0 10.3v1.4c0 2.1.4 4.1.4 4.1[...]
                   <path fill="#FFF" d="M9.8 15.6V8.4l6.4 3.6z"/>
                 </svg>`
              : 'ðŸ”’'}
            ${video.title}
          </span>
          <button class="youtube-download-icon download-btn"
                  style="background:none; border:none; padding:0; cursor:pointer;"
                  title="Download from YouTube">
            <canvas width="32" height="32" class="yt-canvas"></canvas>
            <span style="font-size:12px; color:#FF0000; font-weight:bold;">Download</span>
          </button>
        `
        card.onclick = ()=> handleVideoClick(video, unlocked)
        // Draw YouTube canvas icon for each button
        const ytCanvas = card.querySelector('.yt-canvas');
        if (ytCanvas) {
          const ctx = ytCanvas.getContext('2d');
          // Draw red rounded rectangle
          ctx.beginPath();
          const x = 2, y = 7, width = 28, height = 18, radius = 6;
          ctx.moveTo(x + radius, y);
          ctx.lineTo(x + width - radius, y);
          ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
          ctx.lineTo(x + width, y + height - radius);
          ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
          ctx.lineTo(x + radius, y + height);
          ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
          ctx.lineTo(x, y + radius);
          ctx.quadraticCurveTo(x, y, x + radius, y);
          ctx.closePath();
          ctx.fillStyle = "#FF0000";
          ctx.fill();
          // Draw white play triangle
          ctx.beginPath();
          ctx.moveTo(13, 12); // top
          ctx.lineTo(13, 22); // bottom
          ctx.lineTo(22, 17); // right
          ctx.closePath();
          ctx.fillStyle = "#FFFFFF";
          ctx.fill();
        }
        // Download button logic:
        const dlBtn = card.querySelector('.download-btn')
        if(dlBtn){
          dlBtn.onclick = (e)=>{
            e.stopPropagation()
            if(unlocked){
              // Use savefrom.net instead of y2mate
              window.open(`https://en1.savefrom.net/1-youtube-video-downloader-8jH/?url=https://www.youtube.com/watch?v=${video['video id']}`, '_blank')
              alert('Successful download on YouTube.')
            }else{
              alert('To download this content, you need to subscribe.')
            }
          }
        }
        semDiv.appendChild(card)
      })
      secDiv.appendChild(semDiv)
    })

    container.appendChild(secDiv)
  })
}

function playVideoById(videoId){
  videoFrame.src = `https://www.youtube.com/embed/${videoId}`
}

async function handleVideoClick(video, unlocked){
  if(unlocked){
    playVideoById(video['video id'])
    return
  }
  const pw = prompt('You are not subscribed to this course. Enter password to watch:')
  if(pw===null) return
  const passwords = passwordsFor(video).map(s=>s.toLowerCase())
  if(passwords.includes(pw.trim().toLowerCase())){
    playVideoById(video['video id'])
  } else {
    alert('Incorrect password or access denied.')
  }
}
</script>
</body>
</html>
