<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Thrives Archivers Course Access</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Layout & visuals (kept consistent with your original) */
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; }
    header { background-color: #333; color: #fff; text-align: center; padding: 10px; position: relative; }
    header img { width: 100%; max-height: 250px; object-fit: cover; }
    header h1 { margin-top: 10px; }
    .container { max-width: 1200px; margin: auto; padding: 20px; }

    .course-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
    .course-card { background: #fff; padding: 15px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .course-card h3 { margin-top: 0; }
    .course-card ul { list-style: none; padding-left: 0; }
    .course-card li { margin-bottom: 12px; display: flex; flex-direction: column; gap: 6px; }

    .doc-link { text-decoration: none; color: #007BFF; cursor: pointer; }
    .doc-link:hover { text-decoration: underline; }

    .take-quiz-btn {
      display: inline-block; margin-top: 4px; padding: 8px 16px; background-color: #e0e0e0; color: #333;
      border-radius: 5px; font-size: 14px; text-decoration: none; border: 1px solid #ccc; cursor: pointer;
    }
    .take-quiz-btn:hover { background-color: #d5d5d5; }

    .free-quiz-btn {
      display: inline-block; margin-top: 12px; padding: 12px 20px; background: linear-gradient(90deg,#ff7e5f,#feb47b);
      color: #fff; border-radius: 6px; font-size: 16px; font-weight: bold; text-decoration: none; border: none; cursor: pointer;
    }
    .whatsapp-button { display:inline-block; margin-top:10px; padding:12px 20px; background:#25D366; color:#fff; border-radius:6px; text-decoration:none; }

    .status-badge { padding: 6px 10px; border-radius: 999px; background: rgba(0,0,0,0.08); display: inline-block; margin-left: 10px; font-weight: 600; }

    /* Modal */
    .modal { display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.8); }
    .modal-content { background-color:#fff; margin:5% auto; width:90%; max-width:900px; border-radius:10px; overflow:hidden; position:relative; }
    .modal-content iframe { width:100%; height:600px; border:none; }
    .close-btn { position:absolute; top:5px; right:10px; font-size:24px; color:#333; cursor:pointer; font-weight:bold; }

    /* Admin panel */
    .admin-toolbar { display:none; margin-bottom:20px; }
    .admin-panel { background:#fff; padding:12px; border-radius:8px; box-shadow:0 0 6px rgba(0,0,0,0.08); }
    .admin-panel input, .admin-panel select { padding:8px; width:100%; margin-bottom:8px; border-radius:4px; border:1px solid #ddd; }
    .btn { padding:8px 12px; border-radius:6px; border:none; cursor:pointer; }
    .btn-primary { background:#007bff; color:#fff; }
    .btn-danger { background:#dc3545; color:#fff; }
    .btn-ghost { background:#f0f0f0; color:#333; }

    .entry-controls { display:flex; gap:8px; margin-top:6px; }

    /* Login modal */
    .login-modal { display:none; position:fixed; z-index:11000; left:0; top:0; width:100%; height:100%; background: rgba(0,0,0,0.6); }
    .login-content { background:#fff; width:360px; max-width:95%; margin:6% auto; padding:16px; border-radius:8px; position:relative; }
    .login-content h3 { margin:0 0 12px 0; }
    .login-content input { width:100%; padding:8px; margin-bottom:8px; border:1px solid #ddd; border-radius:4px; }
    .login-close { position:absolute; right:10px; top:8px; cursor:pointer; font-weight:bold; }

    /* Corner auth button with small menu (hidden by default) */
    .corner-auth { position: fixed; top: 12px; left: 12px; z-index: 12000; display:flex; gap:6px; align-items:center; }
    .corner-btn { background:#333; color:#fff; border-radius:6px; padding:8px 10px; border:none; cursor:pointer; font-weight:700; }
    .corner-menu { display:none; background:#fff; color:#333; border-radius:6px; box-shadow:0 2px 8px rgba(0,0,0,0.15); overflow:hidden; margin-left:6px; min-width:180px; }
    .corner-menu button { display:block; width:100%; padding:8px 12px; background:none; border:none; text-align:left; cursor:pointer; }
    .corner-menu button:hover { background:#f4f4f4; }

    @media (max-width:600px) {
      header .user-info { position:static; margin-top:8px; display:block; background:transparent; }
      .entry-controls { flex-direction:column; }
      .login-content { margin-top:20%; }
      .corner-auth { left:8px; top:8px; }
    }
  </style>
</head>
<body>
  <!-- Corner auth button & menu -->
  <div class="corner-auth">
    <button id="cornerMainBtn" class="corner-btn">Account</button>
    <div id="cornerMenu" class="corner-menu" aria-hidden="true">
      <button id="cornerLoginBtn">Sign in / Sign up</button>
      <button id="cornerGuestBtn">Continue as Guest</button>
      <button id="cornerLogoutBtn" style="display:none;">Sign Out</button>
    </div>
  </div>

  <header>
    <img src="file_0000000009d461f89d0cb3387f0b7000.png" alt="Header Image">
    <h1>Thrives Archivers Course Access</h1>

    <!-- User info (top-right) -->
    <div class="user-info" id="userArea" style="position:absolute; right:12px; top:12px;">
      <span id="userEmail">Not signed in</span>
      <span id="enrollStatus" class="status-badge"></span>
      <button id="enrollBtn" style="display:none;">Enroll</button>
    </div>
  </header>

  <div class="container">
    <!-- Admin toolbar (only visible to admin) -->
    <div class="admin-toolbar" id="adminToolbar">
      <div class="admin-panel">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <strong>Admin panel</strong>
          <small style="color:#666;">Signed in as admin: <span id="adminEmailLabel"></span></small>
        </div>

        <form id="entryForm">
          <input type="hidden" id="editingId" value="" />
          <label>Section</label>
          <input id="fieldSection" placeholder="Gross Anatomy" required />
          <label>Title</label>
          <input id="fieldTitle" placeholder="Anatomy of a Hand" required />
          <label>Drive notes (preview link)</label>
          <input id="fieldDrive" placeholder="https://drive.google.com/file/d/xxx/preview" />
          <label>YouTube embed link</label>
          <input id="fieldYouTube" placeholder="https://www.youtube.com/embed/VIDEO_ID" />
          <label>Quiz page (relative path)</label>
          <input id="fieldQuiz" placeholder="Historogy1.html" />
          <label>Order (int)</label>
          <input id="fieldOrder" type="number" value="10" />
          <label>Published?</label>
          <select id="fieldPublished"><option value="true">Yes</option><option value="false">No</option></select>
          <label>Free for guests?</label>
          <select id="fieldFree"><option value="false">No</option><option value="true">Yes</option></select>

          <div style="margin-top:10px; display:flex; gap:8px;">
            <button class="btn btn-primary" type="submit">Save Entry</button>
            <button class="btn btn-ghost" id="clearForm" type="button">Clear</button>
            <button class="btn btn-ghost" id="reloadEntries" type="button">Reload</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Course grid (populated from Supabase anatomy table) -->
    <div class="course-grid" id="courseGrid"></div>

    <a class="free-quiz-btn" href="anatomyquize.html" target="_blank">Go to Anatomy Quiz</a>
    <a class="whatsapp-button" href="https://wa.me/260973178100" target="_blank">Chat with Me on WhatsApp üí¨</a>
  </div>

  <!-- Viewer modal -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal()">&times;</span>
      <iframe id="viewerFrame" src=""></iframe>
    </div>
  </div>

  <!-- Login modal (email/password) -->
  <div id="loginModal" class="login-modal" aria-hidden="true">
    <div class="login-content" role="dialog" aria-modal="true">
      <span id="loginClose" class="login-close">&times;</span>
      <h3 id="loginTitle">Sign In</h3>
      <form id="loginForm">
        <input id="loginEmail" type="email" placeholder="Email" required />
        <input id="loginPassword" type="password" placeholder="Password" required />
        <button id="loginSubmit" class="btn btn-primary" style="width:100%;">Sign In</button>
      </form>
      <div style="margin-top:8px; display:flex; gap:8px;">
        <button id="showSignup" class="btn btn-ghost" style="flex:1;">Create account</button>
        <button id="forgotPassword" class="btn btn-ghost" style="flex:1;">Forgot password</button>
      </div>
      <div style="margin-top:10px; color:#666; font-size:13px;">
        Note: This page uses email & password auth (no magic links). Guests can browse free items.
      </div>
    </div>
  </div>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
  <script>
    // ---------- CONFIG ----------
    const supabaseUrl = 'https://odwiqajuubcgrrqipyju.supabase.co'
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9kd2lxYWp1dWJjZ3JycWlweWp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyNzA4MjEsImV4cCI6MjA2ODg0NjgyMX0.CPyCmqvr0QIx3PJUsZkYqRR3nGzG0kHlvStj49_U24A'
  const supabase = createClient(supabaseUrl, supabaseKey)
   const ADMIN_EMAIL = "thrivesarchivers@gmail.com";
    const SUBS_TABLE = "subscription";
    const ANATOMY_TABLE = "anatomy";

    // ---------- INIT ----------
    const supabase = supabase_js.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // UI references
    const userEmailEl = document.getElementById('userEmail');
    const enrollStatusEl = document.getElementById('enrollStatus');
    const enrollBtn = document.getElementById('enrollBtn');
    const courseGrid = document.getElementById('courseGrid');
    const adminToolbar = document.getElementById('adminToolbar');
    const adminEmailLabel = document.getElementById('adminEmailLabel');

    // corner menu
    const cornerMainBtn = document.getElementById('cornerMainBtn');
    const cornerMenu = document.getElementById('cornerMenu');
    const cornerLoginBtn = document.getElementById('cornerLoginBtn');
    const cornerGuestBtn = document.getElementById('cornerGuestBtn');
    const cornerLogoutBtn = document.getElementById('cornerLogoutBtn');

    // login modal elements
    const loginModal = document.getElementById('loginModal');
    const loginClose = document.getElementById('loginClose');
    const loginForm = document.getElementById('loginForm');
    const loginEmail = document.getElementById('loginEmail');
    const loginPassword = document.getElementById('loginPassword');
    const loginTitle = document.getElementById('loginTitle');
    const showSignupBtn = document.getElementById('showSignup');
    const forgotPasswordBtn = document.getElementById('forgotPassword');

    // admin form
    const entryForm = document.getElementById('entryForm');
    const clearFormBtn = document.getElementById('clearForm');
    const reloadBtn = document.getElementById('reloadEntries');

    // ---------- UTILS ----------
    function setGuestMode(enabled) {
      localStorage.setItem('thrives_guest', enabled ? '1' : '0');
      updateUIForUser(null, enabled);
      loadAnatomyEntries();
    }
    function isGuestMode() { return localStorage.getItem('thrives_guest') === '1'; }

    async function getCurrentUser() {
      const { data } = await supabase.auth.getUser();
      return data.user ?? null;
    }

    function openCornerMenu(toggle = true) {
      if (toggle) cornerMenu.style.display = cornerMenu.style.display === 'block' ? 'none' : 'block';
      else cornerMenu.style.display = 'block';
      cornerMenu.setAttribute('aria-hidden', cornerMenu.style.display === 'none');
    }

    function closeModal() {
      document.getElementById('modal').style.display = 'none';
      document.getElementById('viewerFrame').src = '';
    }

    // when clicking outside close corner menu
    document.addEventListener('click', (e) => {
      if (!cornerMainBtn.contains(e.target) && !cornerMenu.contains(e.target)) {
        cornerMenu.style.display = 'none';
      }
    });

    // ---------- AUTH UI HANDLERS ----------
    cornerMainBtn.addEventListener('click', () => openCornerMenu());
    cornerLoginBtn.addEventListener('click', () => {
      loginTitle.textContent = 'Sign In';
      loginForm.dataset.mode = 'signin';
      loginModal.style.display = 'block';
      openCornerMenu(false);
    });
    cornerGuestBtn.addEventListener('click', () => {
      setGuestMode(true);
      alert('Browsing as Guest. Free items are available. Sign in anytime.');
      openCornerMenu(false);
    });
    cornerLogoutBtn.addEventListener('click', async () => {
      await signOut();
      openCornerMenu(false);
    });

    loginClose.addEventListener('click', () => loginModal.style.display = 'none');
    window.addEventListener('keydown', (e) => { if (e.key === 'Escape') loginModal.style.display = 'none'; });

    showSignupBtn.addEventListener('click', () => {
      loginTitle.textContent = 'Create account';
      loginForm.dataset.mode = 'signup';
      loginModal.style.display = 'block';
    });

    forgotPasswordBtn.addEventListener('click', async () => {
      const email = prompt('Enter your email to receive a password recovery link:');
      if (!email) return;
      const { error } = await supabase.auth.resetPasswordForEmail(email);
      if (error) alert('Could not send recovery email: ' + error.message);
      else alert('Recovery email sent. Check your inbox.');
    });

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = loginEmail.value.trim();
      const password = loginPassword.value;
      const mode = loginForm.dataset.mode || 'signin';
      if (!email || !password) return alert('Enter email and password.');

      if (mode === 'signin') {
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) return alert('Sign in failed: ' + error.message);
        loginModal.style.display = 'none';
        loginForm.reset();
        // clear guest mode
        localStorage.setItem('thrives_guest', '0');
      } else {
        // signup
        const { data, error } = await supabase.auth.signUp({ email, password });
        if (error) return alert('Sign up failed: ' + error.message);
        alert('Account created. If email confirmation is required, confirm and then sign in.');
        loginForm.dataset.mode = 'signin';
        loginForm.reset();
      }
    });

    async function signOut() {
      localStorage.setItem('thrives_guest', '0');
      await supabase.auth.signOut();
      updateUIForUser(null, false);
      loadAnatomyEntries();
    }

    // Listen to auth changes (update UI)
    supabase.auth.onAuthStateChange((event, session) => {
      const user = session?.user ?? null;
      updateUIForUser(user, false);
      loadAnatomyEntries();
    });

    // ---------- SUBSCRIPTION CHECK ----------
    async function checkSubscriptionStatus(email) {
      if (!email) {
        enrollStatusEl.textContent = '';
        enrollBtn.style.display = 'none';
        return false;
      }
      const { data, error } = await supabase.from(SUBS_TABLE).select('*').eq('email', email);
      if (error) { console.error(error); enrollStatusEl.textContent = 'Status: Unknown'; return false; }
      const now = new Date();
      let enrolled = false;
      if (data && data.length > 0) {
        for (const row of data) {
          let courses = row.courses;
          if (typeof courses === 'string') {
            try { courses = JSON.parse(courses); } catch (e) {}
          }
          const hasAnatomy = Array.isArray(courses)
            ? courses.map(c => String(c).toLowerCase()).includes('anatomy')
            : String(courses || '').toLowerCase().includes('anatomy');
          const start = row.start_date ? new Date(row.start_date) : null;
          const end = row.end_date ? new Date(row.end_date) : null;
          const within = (!start || now >= start) && (!end || now <= end);
          if (hasAnatomy && within) { enrolled = true; break; }
        }
      }
      enrollStatusEl.textContent = enrolled ? 'Enrolled' : 'Not enrolled';
      enrollBtn.style.display = enrolled ? 'none' : 'inline-block';
      return enrolled;
    }

    // Enroll button: create a pending subscription row & open WhatsApp
    enrollBtn.addEventListener('click', async () => {
      const { data } = await supabase.auth.getUser();
      const user = data.user ?? null;
      if (!user) {
        if (confirm('You must sign in to enroll. Sign in now?')) {
          loginTitle.textContent = 'Sign In';
          loginForm.dataset.mode = 'signin';
          loginModal.style.display = 'block';
        }
        return;
      }
      const phone = '260973178100';
      const message = encodeURIComponent(`Hello, I want to enroll for Anatomy. Email: ${user.email}. I will pay K100.`);
      if (confirm('Create a pending enrollment record so admin can follow up?')) {
        const start = new Date().toISOString();
        const end = new Date(Date.now() + 30*24*60*60*1000).toISOString();
        const payload = {
          email: user.email,
          start_date: start,
          end_date: end,
          duration: 30,
          courses: JSON.stringify(['Anatomy']),
          status: 'pending'
        };
        const { error } = await supabase.from(SUBS_TABLE).insert([payload]);
        if (error) alert('Could not create pending subscription: ' + error.message);
        else alert('Pending enrollment created. Please complete payment via WhatsApp.');
      }
      window.open(`https://wa.me/${phone}?text=${message}`, '_blank');
    });

    // ---------- LOAD & RENDER ANATOMY ENTRIES ----------
    // Renders only published entries. If guest mode -> only show item.free === true
    async function loadAnatomyEntries() {
      const { data, error } = await supabase.from(ANATOMY_TABLE).select('*').order('order', { ascending: true });
      if (error) {
        console.error('Error loading anatomy entries:', error);
        courseGrid.innerHTML = `<div class="course-card"><h3>Error loading content</h3><p>Could not load dynamic content.</p></div>`;
        return;
      }
      if (!data || data.length === 0) {
        courseGrid.innerHTML = `<div class="course-card"><h3>No content yet</h3><p>Admin can add anatomy entries via the admin panel.</p></div>`;
        return;
      }

      const guest = isGuestMode();
      let html = '';
      // group by section
      const grouped = {};
      for (const item of data) {
        if (!item.published) continue;
        if (guest && item.free !== true) continue; // guests see only free items
        const section = item.section || 'General';
        if (!grouped[section]) grouped[section] = [];
        grouped[section].push(item);
      }

      for (const [section, items] of Object.entries(grouped)) {
        html += `<div class="course-card"><h3>${escapeHtml(section)}</h3><ul>`;
        for (const item of items) {
          html += `<li>`;
          if (item.drive_link) {
            html += `<a class="doc-link" onclick="checkEnrollmentAndOpen('${escapeAttr(item.drive_link)}')">üìÑ ${escapeHtml(item.title || 'Notes')}</a>`;
          } else {
            html += `<span style="font-weight:600;">${escapeHtml(item.title || 'Untitled')}</span>`;
          }
          if (item.youtube_link) {
            html += `<button class="take-quiz-btn" onclick="checkEnrollmentAndOpen('${escapeAttr(item.youtube_link)}')">üé• Video</button>`;
          }
          if (item.quiz_page) {
            html += `<button class="take-quiz-btn" onclick="checkEnrollmentAndOpen('${escapeAttr(item.quiz_page)}')">üìù Quiz</button>`;
          }

          // admin controls (visible only to admin)
          html += `<div class="entry-controls" data-entry-id="${item.id}" style="display:none;">`;
          html += `<button class="btn btn-ghost btn-edit" data-id="${item.id}">Edit</button>`;
          html += `<button class="btn btn-danger btn-delete" data-id="${item.id}">Delete</button>`;
          html += `</div>`;

          html += `</li>`;
        }
        html += `</ul></div>`;
      }

      courseGrid.innerHTML = html;

      // Attach admin listeners
      document.querySelectorAll('.btn-edit').forEach(b => b.addEventListener('click', onEditClick));
      document.querySelectorAll('.btn-delete').forEach(b => b.addEventListener('click', onDeleteClick));

      // show/hide entry-controls based on admin
      const user = await getCurrentUser();
      if (user && user.email === ADMIN_EMAIL) {
        document.querySelectorAll('.entry-controls').forEach(ec => ec.style.display = 'flex');
      } else {
        document.querySelectorAll('.entry-controls').forEach(ec => ec.style.display = 'none');
      }

      // update enroll button visibility for current session
      if (user) await checkSubscriptionStatus(user.email);
      else if (isGuestMode()) { enrollStatusEl.textContent = 'Guest'; enrollBtn.style.display = 'inline-block'; }
      else { enrollStatusEl.textContent = ''; enrollBtn.style.display = 'none'; }
    }

    // ---------- ADMIN: edit & delete ----------
    async function onEditClick(e) {
      const id = e.target.getAttribute('data-id');
      if (!id) return;
      const { data, error } = await supabase.from(ANATOMY_TABLE).select('*').eq('id', id).single();
      if (error) { alert('Could not fetch entry for edit'); console.error(error); return; }
      document.getElementById('editingId').value = data.id;
      document.getElementById('fieldSection').value = data.section || '';
      document.getElementById('fieldTitle').value = data.title || '';
      document.getElementById('fieldDrive').value = data.drive_link || '';
      document.getElementById('fieldYouTube').value = data.youtube_link || '';
      document.getElementById('fieldQuiz').value = data.quiz_page || '';
      document.getElementById('fieldOrder').value = data.order ?? 10;
      document.getElementById('fieldPublished').value = data.published ? 'true' : 'false';
      document.getElementById('fieldFree').value = data.free ? 'true' : 'false';
      adminToolbar.style.display = 'block';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function onDeleteClick(e) {
      const id = e.target.getAttribute('data-id');
      if (!id) return;
      if (!confirm('Delete this entry? This cannot be undone.')) return;
      const { error } = await supabase.from(ANATOMY_TABLE).delete().eq('id', id);
      if (error) { alert('Delete failed: ' + error.message); console.error(error); }
      else { alert('Deleted'); await loadAnatomyEntries(); }
    }

    // ---------- ADMIN: create/update form ----------
    entryForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const editingId = document.getElementById('editingId').value || null;
      const section = document.getElementById('fieldSection').value.trim();
      const title = document.getElementById('fieldTitle').value.trim();
      const drive_link = document.getElementById('fieldDrive').value.trim();
      const youtube_link = document.getElementById('fieldYouTube').value.trim();
      const quiz_page = document.getElementById('fieldQuiz').value.trim();
      const order = parseInt(document.getElementById('fieldOrder').value) || 0;
      const published = document.getElementById('fieldPublished').value === 'true';
      const free = document.getElementById('fieldFree').value === 'true';

      const user = await getCurrentUser();
      if (!user || user.email !== ADMIN_EMAIL) return alert('Only admin can create/update entries.');

      if (editingId) {
        const { error } = await supabase.from(ANATOMY_TABLE).update({
          section, title, drive_link, youtube_link, quiz_page, order, published, free, updated_at: new Date().toISOString()
        }).eq('id', editingId);
        if (error) return alert('Update failed: ' + error.message);
        alert('Updated');
        entryForm.reset();
        document.getElementById('editingId').value = '';
        await loadAnatomyEntries();
      } else {
        const { error } = await supabase.from(ANATOMY_TABLE).insert([{
          section, title, drive_link, youtube_link, quiz_page, order, published, free
        }]);
        if (error) return alert('Insert failed: ' + error.message);
        alert('Saved');
        entryForm.reset();
        await loadAnatomyEntries();
      }
    });

    clearFormBtn.addEventListener('click', () => { entryForm.reset(); document.getElementById('editingId').value = ''; });
    reloadBtn.addEventListener('click', () => loadAnatomyEntries());

    // ---------- ACCESS CONTROL: check enrollment & open ----------
    async function checkEnrollmentAndOpen(link) {
      // decide whether link can be opened or must be gated
      const user = await getCurrentUser();
      if (!user) {
        if (isGuestMode()) {
          // Guests -> only free links opened by load function (guests shouldn't see non-free)
          alert('Sign in to access this content (guests can access free content only).');
          return;
        }
        if (confirm('You need to sign in to access this content. Sign in now?')) {
          loginTitle.textContent = 'Sign In';
          loginForm.dataset.mode = 'signin';
          loginModal.style.display = 'block';
        }
        return;
      }
      // admin bypass
      if (user.email === ADMIN_EMAIL) { openInModal(link); return; }

      // check subscription
      const { data, error } = await supabase.from(SUBS_TABLE).select('*').eq('email', user.email);
      if (error) { alert('Could not verify subscription. Contact admin.'); console.error(error); return; }
      const now = new Date();
      let enrolled = false;
      if (data && data.length > 0) {
        for (const row of data) {
          let courses = row.courses;
          if (typeof courses === 'string') {
            try { courses = JSON.parse(courses); } catch (e) {}
          }
          const hasAnatomy = Array.isArray(courses)
            ? courses.map(c => String(c).toLowerCase()).includes('anatomy')
            : String(courses || '').toLowerCase().includes('anatomy');
          const start = row.start_date ? new Date(row.start_date) : null;
          const end = row.end_date ? new Date(row.end_date) : null;
          const within = (!start || now >= start) && (!end || now <= end);
          if (hasAnatomy && within) { enrolled = true; break; }
        }
      }
      if (enrolled) openInModal(link);
      else {
        if (confirm('You are not enrolled. Contact via WhatsApp to enroll?')) {
          window.open('https://wa.me/260973178100', '_blank');
        }
      }
    }
    window.checkEnrollmentAndOpen = checkEnrollmentAndOpen; // make global for inline onclick

    function openInModal(link) {
      document.getElementById('viewerFrame').src = link;
      document.getElementById('modal').style.display = 'block';
    }
    window.closeModal = closeModal; // global

    // ---------- INITIAL UI UPDATE ----------
    async function updateUIForUser(user = null, guestOverride = null) {
      const guest = guestOverride === null ? isGuestMode() : guestOverride;
      if (guest) {
        userEmailEl.textContent = 'Guest';
        enrollStatusEl.textContent = 'Guest';
        enrollBtn.style.display = 'inline-block';
        cornerLogoutBtn.style.display = 'inline-block';
        cornerLoginBtn.style.display = 'inline-block';
        cornerGuestBtn.style.display = 'inline-block';
        adminToolbar.style.display = 'none';
        cornerLogoutBtn.textContent = 'Exit Guest';
        return;
      }

      if (!user) {
        // fetch current user to be safe
        const { data } = await supabase.auth.getUser();
        user = data.user ?? null;
      }

      if (!user) {
        userEmailEl.textContent = 'Not signed in';
        enrollStatusEl.textContent = '';
        enrollBtn.style.display = 'none';
        cornerLogoutBtn.style.display = 'none';
        cornerLoginBtn.style.display = 'inline-block';
        cornerGuestBtn.style.display = 'inline-block';
        adminToolbar.style.display = 'none';
        adminEmailLabel.textContent = '';
        return;
      }

      userEmailEl.textContent = user.email;
      cornerLoginBtn.style.display = 'none';
      cornerGuestBtn.style.display = 'inline-block';
      cornerLogoutBtn.style.display = 'inline-block';
      cornerLogoutBtn.textContent = 'Sign Out';

      const isAdmin = user.email === ADMIN_EMAIL;
      if (isAdmin) {
        adminToolbar.style.display = 'block';
        adminEmailLabel.textContent = user.email;
        // Show edit controls on entries
        document.querySelectorAll('.entry-controls').forEach(ec => ec.style.display = 'flex');
      } else {
        adminToolbar.style.display = 'none';
        document.querySelectorAll('.entry-controls').forEach(ec => ec.style.display = 'none');
      }

      await checkSubscriptionStatus(user.email);
    }

    // ---------- UTILITY ESCAPES ----------
    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;");
    }
    function escapeAttr(s) {
      if (!s) return '';
      return String(s).replaceAll("'", "\\'").replaceAll('"', '\\"');
    }

    // ---------- STARTUP ----------
    (async function start() {
      // initialize guest flag if not set
      if (localStorage.getItem('thrives_guest') === null) localStorage.setItem('thrives_guest', '0');

      // Update UI for whatever auth state currently is
      const { data } = await supabase.auth.getUser();
      const user = data.user ?? null;
      const guest = isGuestMode();
      await updateUIForUser(user, guest);

      // Load entries
      await loadAnatomyEntries();
    })();

  </script>
</body>
</html>
