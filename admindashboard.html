<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Thrives Archivers - Video Streaming</title>
<style>
body {
  font-family: Arial, sans-serif;
  margin: 0; padding: 0;
  background: #f5f6fa;
  color: #222;
}
h2 {
  background: #5c258d;
  color: #fff;
  margin: 0;
  padding: 16px 12px;
  letter-spacing: 1px;
}
.status-bar {
  background: #e1e1e7;
  color: #333;
  padding: 8px 12px;
  font-size: 15px;
}
.container {
  padding: 18px;
  max-width: 850px;
  margin: 0 auto;
}
.section {
  margin-bottom: 24px;
  background: #fff;
  border-radius: 6px;
  box-shadow: 0 2px 8px #0001;
  padding: 16px;
}
.section h3 {
  margin-top: 0;
  color: #5c258d;
}
.semester-title {
  margin-top: 10px;
  font-weight: bold;
  color: #3b1167;
}
.video-card {
  cursor: pointer;
  padding: 8px 12px;
  margin: 5px 0;
  background: #f3f2fd;
  border-radius: 5px;
  transition: background 0.2s;
  display: inline-block;
  min-width: 180px;
  position: relative;
}
.video-card:hover { background: #e8e6fd; }
.video-card.locked { color: #999; background: #f7f7f7; border: 1px solid #e2e2e2;}
.video-card .lock {
  margin-left: 8px;
  color: #a70c0c;
  font-size: 18px;
  vertical-align: middle;
}
.video-player {
  max-width: 800px;
  margin: 32px auto 0;
  display: flex;
  justify-content: center;
}
.video-player iframe {
  width: 100%;
  height: 420px;
  max-width: 720px;
  border: none;
  border-radius: 12px;
  background: #000;
}
#adminPanel {
  display: none;
  background: #fff9eb;
  border: 1px solid #f9c56b;
  padding: 18px;
  max-width: 850px;
  margin: 30px auto 0;
  border-radius: 7px;
}
#existingVideos {
  margin-top: 16px;
}
#existingVideos .admin-video-row {
  background: #f7f2e3;
  padding: 5px;
  margin: 3px 0;
  border-radius: 4px;
  font-size: 14px;
}
#subscriptionsAdmin {
  margin-top: 16px;
  background: #f9f9f9;
  padding: 10px;
  border-radius: 6px;
}
button, input[type="submit"] {
  background: #5c258d;
  color: #fff;
  border: none;
  border-radius: 4px;
  padding: 7px 14px;
  cursor: pointer;
  font-size: 15px;
  margin: 3px 0;
  transition: background 0.2s;
}
button:hover, input[type="submit"]:hover {
  background: #3b1167;
}
input, select {
  padding: 6px 8px;
  border-radius: 4px;
  border: 1px solid #c2c2c2;
  font-size: 15px;
  margin: 2px 0;
}
.modal-bg {
  position: fixed;
  left: 0; top: 0; right: 0; bottom: 0;
  background: #0008;
  z-index: 1000;
  display: none;
}
.modal {
  position: fixed;
  left: 50%; top: 50%;
  transform: translate(-50%,-50%);
  background: #fff;
  padding: 28px 28px 20px 28px;
  border-radius: 8px;
  box-shadow: 0 8px 30px #0003;
  z-index: 1001;
  min-width: 300px;
  display: none;
}
.modal h3 {
  margin-top: 0;
}
.modal .close-modal {
  position: absolute;
  right: 14px; top: 12px;
  background: none;
  border: none;
  font-size: 20px;
  color: #aaa;
  cursor: pointer;
}
@media (max-width: 600px) {
  .container, #adminPanel {
    padding: 7px;
    max-width: 100%;
  }
  .video-player iframe {
    height: 200px;
    min-width: 180px;
  }
}
</style>
</head>
<body>
<h2>Thrives Archivers - Video Streaming</h2>
<div class="status-bar" id="statusBar"></div>

<!-- LOGIN MODAL -->
<div class="modal-bg" id="modalBg"></div>
<div class="modal" id="loginModal">
  <button class="close-modal" id="closeModalBtn">&times;</button>
  <h3>Login</h3>
  <div>
    <label>Email:<br>
      <input type="email" id="loginEmail" autocomplete="username" required>
    </label>
  </div>
  <div style="margin-top:8px;">
    <label>Password:<br>
      <input type="password" id="loginPassword" autocomplete="current-password" required>
    </label>
  </div>
  <div style="margin-top:14px;">
    <button id="loginBtn">Login</button>
  </div>
</div>

<!-- PASSWORD PROMPT MODAL -->
<div class="modal" id="passwordPromptModal">
  <button class="close-modal" id="closePasswordModalBtn">&times;</button>
  <h3>Enter Video Password</h3>
  <input type="password" id="videoPasswordInput" placeholder="Password">
  <div id="passwordError" style="color: #a70c0c; margin-top: 8px;"></div>
  <div style="margin-top:12px;">
    <button id="videoPasswordBtn">Unlock</button>
  </div>
</div>

<div class="container" id="container"></div>

<div class="video-player">
  <iframe id="videoFrame" src="" allowfullscreen></iframe>
</div>

<!-- ADMIN PANEL (visible only for admin user) -->
<div id="adminPanel">
  <h3>Admin Panel</h3>

  <form id="addVideoForm" autocomplete="off">
    <strong>Add New Video</strong><br>
    <label>Title: <input type="text" id="videoTitle" required></label>
    <label>Section: <input type="text" id="videoSection" required></label>
    <label>Semester: <input type="text" id="videoSemester" required></label>
    <label>YouTube Video ID: <input type="text" id="videoID" required></label>
    <label>Password(s) (optional, comma separated): <input type="text" id="videoPasswords"></label>
    <label>Order: <input type="number" id="videoOrder" value="1" min="1"></label>
    <input type="submit" value="Add Video">
  </form>

  <div id="existingVideos"></div>

  <div id="subscriptionsAdmin">
    <h4>Subscriptions</h4>
    <div id="subsList">Loading...</div>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

// --- SUPABASE CONFIG ---
const supabaseUrl = 'https://odwiqajuubcgrrqipyju.supabase.co'
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'  // <-- Replace with your anon/public key from Supabase
const supabase = createClient(supabaseUrl, supabaseKey)

// --- ELEMENTS ---
const container = document.getElementById('container')
const videoFrame = document.getElementById('videoFrame')
const adminPanel = document.getElementById('adminPanel')
const addVideoForm = document.getElementById('addVideoForm')
const existingVideosDiv = document.getElementById('existingVideos')
const statusBar = document.getElementById('statusBar')
const loginModal = document.getElementById('loginModal')
const modalBg = document.getElementById('modalBg')
const closeModalBtn = document.getElementById('closeModalBtn')
const loginBtn = document.getElementById('loginBtn')
const loginEmail = document.getElementById('loginEmail')
const loginPassword = document.getElementById('loginPassword')
const subscriptionsAdmin = document.getElementById('subscriptionsAdmin')
const subsList = document.getElementById('subsList')

// Password Prompt Modal
const passwordPromptModal = document.getElementById('passwordPromptModal')
const videoPasswordInput = document.getElementById('videoPasswordInput')
const videoPasswordBtn = document.getElementById('videoPasswordBtn')
const closePasswordModalBtn = document.getElementById('closePasswordModalBtn')
const passwordError = document.getElementById('passwordError')

let currentUser = null
let currentSubscription = null
let allVideos = []
let allSubscriptions = []
let lockedVideoToOpen = null

// --- MODAL HELPERS ---
function showLoginModal() { loginModal.style.display = 'block'; modalBg.style.display = 'block'; }
function hideLoginModal() { loginModal.style.display = 'none'; modalBg.style.display = 'none'; }
closeModalBtn.onclick = hideLoginModal

function showPasswordModal(video) {
  passwordPromptModal.style.display = 'block'
  passwordError.textContent = ''
  videoPasswordInput.value = ''
  lockedVideoToOpen = video
}
function hidePasswordModal() {
  passwordPromptModal.style.display = 'none'
  lockedVideoToOpen = null
}
closePasswordModalBtn.onclick = hidePasswordModal

// --- FETCH SUBSCRIPTION ---
async function fetchSubscription(email) {
  if (!email) return null
  const { data, error } = await supabase.from('subscription').select('*').eq('email', email).maybeSingle()
  if (error) return null
  return data
}

// --- AUTH ---
loginBtn.onclick = async function() {
  const email = loginEmail.value.trim()
  const password = loginPassword.value.trim()
  if(!email || !password) return alert('Please enter email and password.')

  const { data, error } = await supabase.auth.signInWithPassword({ email, password })
  if (error) return alert('Login failed: ' + error.message)
  currentUser = data.user
  if (!currentUser) return alert('User login failed.')
  const sub = await fetchSubscription(currentUser.email)
  currentSubscription = sub
  // Auto-create a subscription if not present
  if(!sub) await ensureSubscription(currentUser.email)
  await updateStatusBar()
  hideLoginModal()
  await afterLogin()
}

// On page load, check session
window.addEventListener('DOMContentLoaded', async () => {
  const { data: { session } } = await supabase.auth.getSession()
  if(session && session.user) {
    currentUser = session.user
    let sub = await fetchSubscription(currentUser.email)
    currentSubscription = sub
    if(!sub) await ensureSubscription(currentUser.email)
    await updateStatusBar()
    await afterLogin()
  } else {
    showLoginModal()
  }
})

async function ensureSubscription(email) {
  const { data, error } = await supabase.from('subscription').select('email').eq('email', email).maybeSingle()
  if (!data && !error) {
    const today = new Date();
    const end = new Date(today);
    end.setMonth(end.getMonth() + 1);
    await supabase.from('subscription').insert([{
      email,
      'start date': today.toISOString().split('T')[0],
      duration: 1,
      'end date': end.toISOString().split('T')[0],
      courses: ''
    }]);
  }
}

async function updateStatusBar() {
  if (!currentUser) {
    statusBar.textContent = ""
    return
  }
  const sub = currentSubscription || await fetchSubscription(currentUser.email)
  let courses = 'None'
  if(sub && sub.courses && sub.courses.trim() !== '') {
    courses = sub.courses
  }
  statusBar.textContent = `Logged in as ${currentUser.email} | Subscribed Courses: ${courses}`
}

// --- MAIN AFTER LOGIN ---
async function afterLogin() {
  if(currentUser.email === "thrivesarchivers@gmail.com") {
    adminPanel.style.display = 'block'
    fetchSubscriptions()
  } else {
    adminPanel.style.display = 'none'
  }
  fetchVideos()
}

// --- VIDEOS ---
async function fetchVideos() {
  const { data, error } = await supabase.from('Videos').select('*').order('order', { ascending: true })
  if (error) { container.innerHTML = "<b>Failed to load videos.</b>"; return }
  allVideos = data
  renderVideos(data)
  if(currentUser && currentUser.email === "thrivesarchivers@gmail.com") renderExistingVideos(data)
}

function getSubscribedCoursesArr() {
  if(!currentSubscription) return []
  if(!currentSubscription.courses) return []
  return currentSubscription.courses.split(',').map(s => s.trim()).filter(s => s)
}

function isSubscribedToCourse(course) {
  if(!currentSubscription) return false
  if(!currentSubscription.courses) return false
  if(currentSubscription.courses.trim() === '') return true
  return getSubscribedCoursesArr().map(e=>e.toLowerCase()).includes(course.toLowerCase())
}

function renderVideos(videos) {
  let grouped = {}
  videos.forEach(v => {
    let sec = v.section || 'Other'
    let sem = v.semester || 'Other'
    if(!grouped[sec]) grouped[sec] = {}
    if(!grouped[sec][sem]) grouped[sec][sem] = []
    grouped[sec][sem].push(v)
  })
  container.innerHTML = ""
  Object.keys(grouped).forEach(section => {
    let secDiv = document.createElement('div')
    secDiv.className = 'section'
    secDiv.innerHTML = `<h3>${section}</h3>`
    Object.keys(grouped[section]).forEach(semester => {
      let semDiv = document.createElement('div')
      semDiv.innerHTML = `<div class="semester-title">${semester}</div>`
      grouped[section][semester].forEach(video => {
        let vidDiv = document.createElement('div')
        let locked = !isSubscribedToCourse(video.section)
        vidDiv.className = 'video-card' + (locked ? ' locked' : '')
        vidDiv.textContent = video.title
        if(locked) {
          const lockSpan = document.createElement('span')
          lockSpan.textContent = '🔒'
          lockSpan.className = 'lock'
          vidDiv.appendChild(lockSpan)
          // Click: prompt for password
          vidDiv.onclick = () => showPasswordModal(video)
        } else {
          vidDiv.onclick = () => openVideo(video)
        }
        semDiv.appendChild(vidDiv)
      })
      secDiv.appendChild(semDiv)
    })
    container.appendChild(secDiv)
  })
}

// --- VIDEO OPEN LOGIC ---
function openVideo(video) {
  // If video has passwords, prompt for one
  if(video.passwords && video.passwords.trim() !== "") {
    showPasswordModal(video)
  } else {
    videoFrame.src = `https://www.youtube.com/embed/${video.videoID}`
  }
}

// Handle password modal
videoPasswordBtn.onclick = function() {
  const pwd = videoPasswordInput.value.trim()
  if(!lockedVideoToOpen) return
  if(!lockedVideoToOpen.passwords) return
  const validPwds = lockedVideoToOpen.passwords.split(',').map(s => s.trim())
  if(validPwds.includes(pwd)) {
    hidePasswordModal()
    videoFrame.src = `https://www.youtube.com/embed/${lockedVideoToOpen.videoID}`
  } else {
    passwordError.textContent = "Incorrect password!"
  }
}

// --- ADMIN PANEL CODE ---
// Add Video
addVideoForm.onsubmit = async function(e) {
  e.preventDefault()
  const title = document.getElementById('videoTitle').value.trim()
  const section = document.getElementById('videoSection').value.trim()
  const semester = document.getElementById('videoSemester').value.trim()
  const videoID = document.getElementById('videoID').value.trim()
  const passwords = document.getElementById('videoPasswords').value.trim()
  const order = parseInt(document.getElementById('videoOrder').value, 10)
  if(!title || !section || !semester || !videoID) {
    alert('Fill in all required fields.')
    return
  }
  const { error } = await supabase.from('Videos').insert([{
    title, section, semester, videoID, passwords, order
  }])
  if(error) {
    alert('Failed to add video: ' + error.message)
    return
  }
  addVideoForm.reset()
  fetchVideos()
}

// Render Existing Videos (admin)
function renderExistingVideos(videos) {
  existingVideosDiv.innerHTML = "<h4>Existing Videos</h4>"
  videos.forEach(v => {
    const row = document.createElement('div')
    row.className = 'admin-video-row'
    row.textContent = `[${v.order}] ${v.title} (${v.section} / ${v.semester})`
    const delBtn = document.createElement('button')
    delBtn.textContent = 'Delete'
    delBtn.style.marginLeft = '10px'
    delBtn.onclick = async () => {
      if(confirm(`Delete video "${v.title}"?`)) {
        await supabase.from('Videos').delete().eq('id', v.id)
        fetchVideos()
      }
    }
    row.appendChild(delBtn)
    existingVideosDiv.appendChild(row)
  })
}

// Fetch and render subscriptions (admin)
async function fetchSubscriptions() {
  const { data, error } = await supabase.from('subscription').select('*').order('email', {ascending: true})
  if(error) { subsList.innerHTML = "Failed to load subscriptions."; return }
  allSubscriptions = data
  renderSubscriptions(data)
}
function renderSubscriptions(subs) {
  if(!subs.length) { subsList.innerHTML = "None."; return }
  subsList.innerHTML = ""
  subs.forEach(sub => {
    const row = document.createElement('div')
    row.innerHTML = `<b>${sub.email}</b> | Courses: <input type="text" style="width:200px;" value="${sub.courses || ''}" data-email="${sub.email}">`
    const saveBtn = document.createElement('button')
    saveBtn.textContent = "Save"
    saveBtn.onclick = async () => {
      const input = row.querySelector('input')
      await supabase.from('subscription').update({courses: input.value.trim()}).eq('email', sub.email)
      fetchSubscriptions()
    }
    row.appendChild(saveBtn)
    subsList.appendChild(row)
  })
}
</script>
</body>
</html>
