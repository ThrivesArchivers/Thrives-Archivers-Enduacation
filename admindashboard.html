<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Thrives Archivers - Video Streaming</title>
<style>
body { font-family: Arial, sans-serif; background:#f4f4f4; margin:0; }
h2 { background:#333; color:white; padding:15px; margin:0; text-align:center; }
.status-bar { margin:10px auto; padding:10px; font-weight:bold; text-align:center; }
.container { display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:20px; padding:20px; }
.section { background:white; padding:15px; border-radius:10px; box-shadow:0 0 15px rgba(0,0,0,0.1); }
.section h3 { margin-top:0; background:#1976d2; color:white; padding:10px; border-radius:5px; }
.semester-title { font-weight:bold; margin-top:10px; color:#333; font-size:14px; }
.video-card { background:#eee; padding:10px; margin:8px 0; border-radius:5px; cursor:pointer; transition:0.3s; }
.video-card:hover { background:#ddd; }
.video-player { margin:20px auto; width:90%; max-width:800px; height:450px; border-radius:10px; overflow:hidden; box-shadow:0 0 15px rgba(0,0,0,0.2); }
iframe { width:100%; height:100%; border:none; }
.admin-panel { background:#fff; padding:20px; margin:20px auto; width:90%; border-radius:10px; box-shadow:0 0 15px rgba(0,0,0,0.2); display:none; }
.admin-panel h3 { margin-top:0; }
.admin-panel input, .admin-panel select { width:100%; margin:5px 0; padding:8px; }
.admin-panel button { margin-top:10px; padding:10px 15px; cursor:pointer; background:#1976d2; color:white; border:none; border-radius:5px; }
.admin-panel button:hover { background:#125ea3; }
.delete-btn { background:red; margin-top:5px; color:white; padding:5px 10px; border:none; border-radius:5px; cursor:pointer; }
.login-modal, .modal-bg { display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; z-index:1000; }
.modal-bg { background:rgba(0,0,0,0.3); }
.login-modal { z-index:1001; left:50%; top:50%; transform:translate(-50%,-50%); background:#fff; padding:30px; border-radius:10px; width:90%; max-width:350px; box-shadow:0 2px 20px #2224; }
.login-modal input { margin:10px 0; width:100%; padding:10px; }
.login-modal button { padding:8px 15px; margin-top:5px; }
</style>
</head>
<body>
<h2>Thrives Archivers - Video Streaming</h2>
<div class="status-bar" id="statusBar"></div>

<!-- Login Modal -->
<div class="modal-bg" id="modalBg"></div>
<div class="login-modal" id="loginModal">
  <h3>Login to your account</h3>
  <input type="email" id="loginEmail" placeholder="Your Email" required>
  <input type="password" id="loginPassword" placeholder="Your Password" required>
  <button id="loginBtn">Login</button>
  <button style="background:#888;" id="closeModalBtn">Cancel</button>
</div>

<div class="container" id="container"></div>

<div class="video-player">
  <iframe id="videoFrame" src="" allowfullscreen></iframe>
</div>

<!-- Admin Panel -->
<div class="admin-panel" id="adminPanel">
  <h3>Admin Panel - Manage Videos & Access</h3>
  <form id="addVideoForm">
    <input type="text" id="videoTitle" placeholder="Video Title" required>
    <input type="text" id="videoID" placeholder="YouTube Video ID" required>
    <input type="text" id="passwordList" placeholder="Passwords (comma separated)" required>
    <select id="videoSection" required>
      <option value="">Select Section</option>
      <option value="Maths">Maths</option>
      <option value="Physics">Physics</option>
      <option value="Chemistry">Chemistry</option>
      <option value="Biology">Biology</option>
    </select>
    <select id="videoSemester" required>
      <option value="">Select Semester</option>
      <option value="First Semester">First Semester</option>
      <option value="Second Semester">Second Semester</option>
    </select>
    <input type="number" id="videoOrder" placeholder="Order (number)" required>
    <button type="submit">Add Video</button>
  </form>
  <div id="existingVideos"></div>
  <hr>
  <h3>Subscriptions Controls</h3>
  <div id="subscriptionsAdmin"></div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const supabaseUrl = 'https://odwiqajuubcgrrqipyju.supabase.co'
// Replace with your Supabase anon/public key
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9kd2lxYWp1dWJjZ3JycWlweWp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyNzA4MjEsImV4cCI6MjA2ODg0NjgyMX0.CPyCmqvr0QIx3PJUsZkYqRR3nGzG0kHlvStj49_U24A'
const supabase = createClient(supabaseUrl, supabaseKey)
const container = document.getElementById('container')
const videoFrame = document.getElementById('videoFrame')
const adminPanel = document.getElementById('adminPanel')
const addVideoForm = document.getElementById('addVideoForm')
const existingVideosDiv = document.getElementById('existingVideos')
const statusBar = document.getElementById('statusBar')
const loginModal = document.getElementById('loginModal')
const modalBg = document.getElementById('modalBg')
const closeModalBtn = document.getElementById('closeModalBtn')
const loginBtn = document.getElementById('loginBtn')
const loginEmail = document.getElementById('loginEmail')
const loginPassword = document.getElementById('loginPassword')
const subscriptionsAdmin = document.getElementById('subscriptionsAdmin')

let currentUser = null
let currentSubscription = null
let allVideos = []

//} = await supabase.from('Videos')
    .insert([{ title, 'video id': video_id, 'password list': password_list, section, semester, order }])
  if (error) return console.error(error)
  addVideoForm.reset()
  fetchVideos()
}

function renderExistingVideos(data) {
  existingVideosDiv.innerHTML = '<h4>Existing Videos:</h4>'
  data.forEach(v => {
    const div = document.createElement('div')
    div.style.borderBottom = "1px solid #ccc"
    div.style.marginBottom = "5px"
    div.style.paddingBottom = "5px"
    div.innerHTML = `
      ${v.title} (${v.section} - ${v.semester})
      <button class="delete-btn" data-id="${v.id}">Delete</button>
    `
    existingVideosDiv.appendChild(div)
  })

  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.onclick = async () => {
      const id = btn.getAttribute('data-id')
      const { error } = await supabase.from('Videos').delete().eq('id', id)
      if (error) return console.error(error)
      fetchVideos()
    }
  })
}

// ---------- Subscriptions Admin ----------
async function fetchSubscriptions() {
  const { data, error } = await supabase.from('subscription').select('*')
  if (error) return (subscriptionsAdmin.innerHTML = "Failed to fetch subscriptions.")
  renderSubscriptionsAdmin(data)
}

function renderSubscriptionsAdmin(data) {
  subscriptionsAdmin.innerHTML = `<h4>All Subscriptions</h4>
    <table border="1" style="width:100%;border-collapse:collapse;">
      <tr><th>Email</th><th>Start</th><th>Duration</th><th>End</th><th>Courses</th><th>Action</th></tr>
      ${data.map(sub=>`
       <tr>
         <td>${sub.email}</td>
         <td>${sub['start date']||''}</td>
         <td>${sub.duration||''}</td>
         <td>${sub['end date']||''}</td>
         <td>${sub.courses||'All'}</td>
         <td>
           <button onclick="editSub('${sub.email}')">Edit</button>
           <button style="background:red;" onclick="deleteSub('${sub.email}')">Delete</button>
         </td>
       </tr>
      `).join('')}
    </table>
    <h4>Add/Update Subscription</h4>
    <form id="addSubForm">
      <input type="email" id="subEmail" placeholder="Email" required>
      <input type="date" id="subStart" placeholder="Start Date">
      <input type="number" id="subDuration" placeholder="Duration (days)">
      <input type="date" id="subEnd" placeholder="End Date">
      <input type="text" id="subCourses" placeholder="Courses (comma separated, blank for ALL)">
      <button type="submit">Save Subscription</button>
    </form>
  `

  // Hook subscription form
  document.getElementById('addSubForm').onsubmit = async (e) => {
    e.preventDefault()
    const email = document.getElementById('subEmail').value.trim().toLowerCase()
    const start = document.getElementById('subStart').value
    const duration = document.getElementById('subDuration').value
    const end = document.getElementById('subEnd').value
    const courses = document.getElementById('subCourses').value

    // Upsert subscription
    const { error } = await supabase.from('subscription').upsert([{
      email, 'start date': start, duration, 'end date': end, courses
    }])
    if (error) return alert("Error:" + error.message)
    fetchSubscriptions()
    alert("Subscription saved/updated!")
  }
}

// Edit subscription
window.editSub = function(email) {
  const row = Array.from(subscriptionsAdmin.querySelectorAll('tr')).find(tr=>tr.children[0]?.textContent===email)
  if(!row) return
  document.getElementById('subEmail').value = row.children[0].textContent
  document.getElementById('subStart').value = row.children[1].textContent
  document.getElementById('subDuration').value = row.children[2].textContent
  document.getElementById('subEnd').value = row.children[3].textContent
  document.getElementById('subCourses').value = row.children[4].textContent==="All" ? "" : row.children[4].textContent
}

// Delete subscription
window.deleteSub = async function(email) {
  if(confirm("Delete subscription for " + email + "?")) {
    const { error } = await supabase.from('subscription').delete().eq('email', email)
    if(error) return alert("Error: "+error.message)
    fetchSubscriptions()
  }
}

// Initial fetch
fetchVideos()
</script>
</body>
</html>
