<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Thrives Archivers - Documents Dashboard</title>
<style>
  :root{
    --brand:#1976d2; --bg:#f4f4f4; --card:#fff; --danger:#e53935; --muted:#777;
  }
  body{font-family:Arial,sans-serif;background:var(--bg);margin:0;padding:0}
  h2{background:#333;color:#fff;text-align:center;padding:15px;margin:0}
  .topbar{display:flex;justify-content:space-between;align-items:center;padding:10px 16px;background:#222;color:#fff}
  .topbar .left{font-weight:bold}
  .topbar .right{display:flex;gap:8px;align-items:center}
  .pill{background:#111;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #444}
  .btn{cursor:pointer;background:var(--brand);color:#fff;border:none;border-radius:6px;padding:8px 12px}
  .btn.ghost{background:#444}
  .btn.danger{background:var(--danger)}
  .container{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:20px;padding:20px}
  .section{background:var(--card);padding:15px;border-radius:12px;box-shadow:0 0 15px rgba(0,0,0,.08)}
  .section h3{margin-top:0;background:var(--brand);color:#fff;padding:10px;border-radius:6px}
  .semester-title{font-weight:bold;margin-top:10px;color:#333;font-size:14px}
  .doc-card{background:#f1f1f1;padding:10px;margin:8px 0;border-radius:8px;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
  .doc-card:hover{background:#e6e6e6}
  iframe{width:100%;height:500px;border:none;margin-top:10px;border-radius:12px;box-shadow:0 0 15px rgba(0,0,0,.2)}
  .admin-panel{background:#fff;padding:20px;margin:20px auto;width:92%;max-width:1000px;border-radius:12px;box-shadow:0 0 15px rgba(0,0,0,.15);display:none}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
  input, select{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px}
  label{font-size:12px;color:var(--muted)}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid #ddd;padding:8px;text-align:left}
  th{background:#fafafa}
</style>
</head>
<body>
<h2>Thrives Archivers - Documents</h2>

<div class="topbar">
  <div class="left">Welcome, <span id="displayName">Guest</span></div>
  <div class="right">
    <span class="pill" id="subInfo">Not logged in</span>
    <button class="btn" id="loginTopBtn">Login</button>
    <button class="btn ghost" id="logoutBtn" style="display:none">Logout</button>
  </div>
</div>

<div id="statusBar" style="text-align:center;padding:10px;font-weight:bold"></div>

<div class="container" id="container"></div>

<iframe id="docViewer"></iframe>

<!-- Admin Panel -->
<div class="admin-panel" id="adminPanel">
  <h3>Admin Panel â€” Manage Documents & Subscriptions</h3>
  <form id="addDocForm">
    <div class="grid">
      <div><label>Title</label><input type="text" id="docTitle" placeholder="Document Title" required /></div>
      <div><label>Document URL (Google Drive Preview Link)</label><input type="text" id="docURL" placeholder="https://drive.google.com/..." required /></div>
      <div><label>Passwords (comma separated)</label><input type="text" id="docPasswords" placeholder="abc123, xyz789" /></div>
      <div>
        <label>Section</label>
        <select id="docSection" required>
          <option value="">Select Section</option>
          <option>Maths</option>
          <option>Physics</option>
          <option>Chemistry</option>
          <option>Biology</option>
          <option>Anatomy</option>
        </select>
      </div>
      <div>
        <label>Semester / Term</label>
        <select id="docSemester" required>
          <option value="">Select</option>
          <option>Semester One</option>
          <option>Semester Two</option>
          <option>Term One</option>
          <option>Term Two</option>
          <option>Term Three</option>
        </select>
      </div>
    </div>
    <div style="margin-top:10px"><button class="btn" type="submit">Add Document</button></div>
  </form>

  <div id="existingDocs" style="margin-top:16px"></div>
  <hr style="margin:20px 0" />

  <h3>Subscriptions Management</h3>
  <div id="subscriptionsAdmin"></div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const supabaseUrl = 'https://your-supabase-url'
const supabaseKey = 'your-supabase-key'
const supabase = createClient(supabaseUrl, supabaseKey)
const ADMIN_EMAIL = 'admin@thrivesarchivers.com'

const container = document.getElementById('container')
const docViewer = document.getElementById('docViewer')
const adminPanel = document.getElementById('adminPanel')
const addDocForm = document.getElementById('addDocForm')
const existingDocs = document.getElementById('existingDocs')
const statusBar = document.getElementById('statusBar')
const loginTopBtn = document.getElementById('loginTopBtn')
const logoutBtn = document.getElementById('logoutBtn')
const displayNameEl = document.getElementById('displayName')
const subInfo = document.getElementById('subInfo')
const subscriptionsAdmin = document.getElementById('subscriptionsAdmin')

let currentUser = null
let subscription = null
let allDocs = []

function formatStatus(){
  if(!currentUser){ statusBar.textContent='Please login'; subInfo.textContent='Not logged in'; displayNameEl.textContent='Guest'; return }
  displayNameEl.textContent=currentUser.email
  subInfo.textContent=subscription? `Subscribed: ${subscription.courses||'All'}` : 'No subscription'
}

// Fetch documents
async function fetchDocs(){
  const { data, error } = await supabase.from('documents').select('*').order('id')
  if(error){ container.innerHTML='<b>Failed to load documents.</b>'; return }
  allDocs = data || []
  renderDocs(allDocs)
  if(currentUser?.email === thrivesarchivers@gmail.com) renderExistingDocs(allDocs)
}

function renderDocs(docs){
  const grouped = {}
  docs.forEach(d=>{
    const sec = d.section || 'Other', sem = d.semester || 'Other'
    grouped[sec] = grouped[sec]||{}
    grouped[sec][sem] = grouped[sec][sem]||[]
    grouped[sec][sem].push(d)
  })
  container.innerHTML = ''
  Object.keys(grouped).sort().forEach(section=>{
    const secDiv = document.createElement('div'); secDiv.className='section'
    secDiv.innerHTML = `<h3>${section}</h3>`
    Object.keys(grouped[section]).sort().forEach(sem=>{
      const semDiv = document.createElement('div')
      semDiv.innerHTML=`<div class="semester-title">${sem}</div>`
      grouped[section][sem].forEach(d=>{
        const card = document.createElement('div'); card.className='doc-card'
        const unlocked = currentUser?.email===ADMIN_EMAIL || !d['password list']
        card.innerHTML=`<span>${d.title}</span><span>${unlocked?'ðŸ“„':'ðŸ”’'}</span>`
        card.onclick=()=> handleDocClick(d, unlocked)
        semDiv.appendChild(card)
      })
      secDiv.appendChild(semDiv)
    })
    container.appendChild(secDiv)
  })
}

function passwordsFor(doc){ return (doc['password list']||'').split(',').map(s=>s.trim().toLowerCase()) }

function handleDocClick(doc, unlocked){
  if(unlocked){ docViewer.src=doc.url; return }
  const pw = prompt('Enter password:'); if(!pw) return
  if(passwordsFor(docfetchSubscriptions() // Refresh after delete
    }
  })

  // Handle add/update subscription
  const addSubForm = document.getElementById('addSubForm')
  addSubForm.onsubmit = async (e) => {
    e.preventDefault()
    const email = document.getElementById('subEmail').value.trim().toLowerCase()
    const start = document.getElementById('subStart').value
    const duration = parseInt(document.getElementById('subDuration').value)
    const courses = document.getElementById('subCourses').value.trim()

    if(!email || !start || Number.isNaN(duration)) return alert('Fill all required fields.')

    // Compute end date
    const startDate = new Date(start)
    const endDate = new Date(startDate)
    endDate.setMonth(endDate.getMonth() + duration)
    const endDateStr = endDate.toISOString().split('T')[0]

    // Upsert subscription (insert or update)
    const { error } = await supabase.from('subscription').upsert([{
      email,
      "start date": start,
      duration,
      "end date": endDateStr,
      courses
    }], { onConflict: ['email'] })

    if(error){ alert('Error: '+error.message); return }
    addSubForm.reset()
    fetchSubscriptions()
    if(currentUser && currentUser.email.toLowerCase() === email) fetchSubscriptionForUser(email).then(formatStatus)
  }
}
</script>
</body>
</html>
