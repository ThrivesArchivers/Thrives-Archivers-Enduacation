<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Thrives Archivers - Video Streaming</title>
<style>
  :root{
    --brand:#1976d2;--ink:#333;--bg:#f4f4f4;--card:#fff;--muted:#777;--danger:#e53935;
  }
  *{box-sizing:border-box}
  body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);margin:0}
  h2{background:#333;color:#fff;padding:15px;margin:0;text-align:center}
  .topbar{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px 16px;background:#222;color:#fff}
  .topbar .left{font-weight:bold}
  .topbar .right{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .pill{background:#111;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #444}
  .btn{cursor:pointer;background:var(--brand);color:#fff;border:none;border-radius:6px;padding:8px 12px}
  .btn.ghost{background:#444}
  .btn.danger{background:var(--danger)}
  .status-bar{margin:10px auto;padding:10px;font-weight:bold;text-align:center}
  .container{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:20px;padding:20px}
  .section{background:#fff;padding:15px;border-radius:12px;box-shadow:0 0 15px rgba(0,0,0,.08)}
  .section h3{margin-top:0;background:var(--brand);color:#fff;padding:10px;border-radius:6px}
  .semester-title{font-weight:bold;margin-top:10px;color:#333;font-size:14px}
  .video-card{background:#f1f1f1;padding:10px;margin:8px 0;border-radius:8px;cursor:pointer;transition:.2s;display:flex;align-items:center;justify-content:space-between;gap:8px}
  .video-card:hover{background:#e6e6e6}
  .lock{font-size:18px}
  .video-player{margin:20px auto;width:92%;max-width:960px;height:540px;border-radius:12px;overflow:hidden;box-shadow:0 0 15px rgba(0,0,0,.2);background:#000}
  iframe{width:100%;height:100%;border:none}
  .admin-panel{background:#fff;padding:20px;margin:20px auto;width:92%;max-width:1000px;border-radius:12px;box-shadow:0 0 15px rgba(0,0,0,.15);display:none}
  .admin-panel h3{margin-top:0}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
  input, select{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px}
  label{font-size:12px;color:var(--muted)}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid #ddd;padding:8px;text-align:left}
  th{background:#fafafa}
  .login-modal,.modal-bg{display:none;position:fixed;left:0;top:0;width:100vw;height:100vh;z-index:1000}
  .modal-bg{background:rgba(0,0,0,.35)}
  .login-modal{z-index:1001;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;padding:26px;border-radius:12px;width:92%;max-width:380px;box-shadow:0 2px 18px #2224}
  .login-modal h3{margin:0 0 10px 0}
  .hint{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
  <h2>Thrives Archivers - Video Streaming</h2>

  <div class="topbar">
    <div class="left">Welcome, <span id="displayName">Guest</span></div>
    <div class="right">
      <span class="pill" id="subInfo">Not logged in</span>
      <button class="btn" id="loginTopBtn">Login</button>
      <button class="btn ghost" id="logoutBtn" style="display:none">Logout</button>
    </div>
  </div>

  <div class="status-bar" id="statusBar"></div>

  <!-- Login Modal -->
  <div class="modal-bg" id="modalBg"></div>
  <div class="login-modal" id="loginModal">
    <h3>Login to your account</h3>
    <div class="hint">Use your Supabase Auth email & password</div>
    <input type="email" id="loginEmail" placeholder="Your Email" required />
    <input type="password" id="loginPassword" placeholder="Your Password" required />
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
      <button class="btn" id="loginBtn">Login</button>
      <button class="btn ghost" id="closeModalBtn">Cancel</button>
    </div>
  </div>

  <div class="container" id="container"></div>

  <div class="video-player">
    <iframe id="videoFrame" src="" allowfullscreen></iframe>
  </div>

  <!-- Admin Panel -->
  <div class="admin-panel" id="adminPanel">
    <h3>Admin Panel — Manage Videos & Access</h3>
    <form id="addVideoForm">
      <div class="grid">
        <div><label>Title</label><input type="text" id="videoTitle" placeholder="Video Title" required /></div>
        <div><label>YouTube Video ID</label><input type="text" id="videoID" placeholder="dQw4w9WgXcQ" required /></div>
        <div><label>Passwords (comma separated)</label><input type="text" id="passwordList" placeholder="abc123, xyz789" required /></div>
        <div>
          <label>Section</label>
          <select id="videoSection" required>
            <option value="">Select Section</option>
            <option>Maths</option>
            <option>Physics</option>
            <option>Chemistry</option>
            <option>Biology</option>
          </select>
        </div>
        <div>
          <label>Semester</label>
          <select id="videoSemester" required>
            <option value="">Select Semester</option>
            <option>First Semester</option>
            <option>Second Semester</option>
          </select>
        </div>
        <div><label>Order (number)</label><input type="number" id="videoOrder" placeholder="1" required /></div>
      </div>
      <div style="margin-top:10px"><button class="btn" type="submit">Add Video</button></div>
    </form>

    <div id="existingVideos" style="margin-top:16px"></div>
    <hr style="margin:20px 0" />

    <h3>Subscriptions Controls</h3>
    <div id="subscriptionsAdmin"></div>
  </div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

// --- SUPABASE CONFIG ---
const supabaseUrl = 'https://odwiqajuubcgrrqipyju.supabase.co'
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9kd2lxYWp1dWJjZ3JycWlweWp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyNzA4MjEsImV4cCI6MjA2ODg0NjgyMX0.CPyCmqvr0QIx3PJUsZkYqRR3nGzG0kHlvStj49_U24A'
const supabase = createClient(supabaseUrl, supabaseKey)

// --- CONSTANTS ---
const ADMIN_EMAIL = 'thrivesarchivers@gmail.com'

// --- ELEMENTS ---
const container = document.getElementById('container')
const videoFrame = document.getElementById('videoFrame')
const adminPanel = document.getElementById('adminPanel')
const addVideoForm = document.getElementById('addVideoForm')
const existingVideosDiv = document.getElementById('existingVideos')
const statusBar = document.getElementById('statusBar')
const loginModal = document.getElementById('loginModal')
const modalBg = document.getElementById('modalBg')
const closeModalBtn = document.getElementById('closeModalBtn')
const loginBtn = document.getElementById('loginBtn')
const loginEmail = document.getElementById('loginEmail')
const loginPassword = document.getElementById('loginPassword')
const loginTopBtn = document.getElementById('loginTopBtn')
const logoutBtn = document.getElementById('logoutBtn')
const displayNameEl = document.getElementById('displayName')
const subInfo = document.getElementById('subInfo')
const subscriptionsAdmin = document.getElementById('subscriptionsAdmin')

// --- STATE ---
let currentUser = null
let subscription = null // row from subscription table
let allVideos = []

// --- HELPERS ---
function showLoginModal(){ loginModal.style.display = 'block'; modalBg.style.display = 'block' }
function hideLoginModal(){ loginModal.style.display = 'none'; modalBg.style.display = 'none' }
function normalizeCourses(str){
  if(!str) return []
  return str.split(',').map(s=>s.trim()).filter(Boolean)
}
function userDisplayName(user){
  const meta = user?.user_metadata || {}
  return meta.name || meta.full_name || meta.fullName || user?.email || 'User'
}
function formatStatus(){
  if(!currentUser){
    statusBar.textContent = 'Please log in to see your subscriptions and watch videos.'
    subInfo.textContent = 'Not logged in'
    displayNameEl.textContent = 'Guest'
    return
  }
  const name = userDisplayName(currentUser)
  const email = currentUser.email
  displayNameEl.textContent = name

  if(!subscription){
    statusBar.textContent = `${email} — You are not subscribed. Locked videos require a password.`
    subInfo.textContent = 'No active subscription'
  } else {
    const courses = subscription.courses?.trim()
    const list = courses ? normalizeCourses(courses).join(', ') : 'All'
    statusBar.textContent = `${email} — Subscribed: ${list}. Start: ${subscription['start date']||'-'} | End: ${subscription['end date']||'-'}`
    subInfo.textContent = `Subscribed: ${list}`
  }
}
function canAccessVideo(video){
  if(!currentUser) return false
  if(currentUser.email === ADMIN_EMAIL) return true
  if(!subscription) return false
  const courses = subscription.courses?.trim()
  if(!courses) return true // blank means ALL courses
  const allowed = new Set(normalizeCourses(courses).map(s=>s.toLowerCase()))
  return allowed.has((video.section||'').toLowerCase())
}
function passwordsFor(video){
  return (video['password list']||'').split(',').map(s=>s.trim()).filter(Boolean)
}

// --- AUTH ---
closeModalBtn.onclick = hideLoginModal
loginTopBtn.onclick = showLoginModal
logoutBtn.onclick = async ()=>{
  await supabase.auth.signOut()
  currentUser = null
  subscription = null
  adminPanel.style.display = 'none'
  logoutBtn.style.display = 'none'
  loginTopBtn.style.display = 'inline-block'
  formatStatus()
  renderVideos(allVideos)
}

loginBtn.onclick = async ()=>{
  const email = loginEmail.value.trim()
  const password = loginPassword.value.trim()
  if(!email || !password) return alert('Please enter email and password.')

  const { data, error } = await supabase.auth.signInWithPassword({ email, password })
  if(error){ alert('Login failed: '+error.message); return }
  currentUser = data.user
  hideLoginModal()
  logoutBtn.style.display = 'inline-block'
  loginTopBtn.style.display = 'none'
  if(currentUser.email === ADMIN_EMAIL){ adminPanel.style.display = 'block'; fetchSubscriptions() }
  await fetchSubscriptionForUser(currentUser.email)
  formatStatus()
  await fetchVideos()
}

window.addEventListener('DOMContentLoaded', async ()=>{
  const { data: { session } } = await supabase.auth.getSession()
  if(session?.user){
    currentUser = session.user
    logoutBtn.style.display = 'inline-block'
    loginTopBtn.style.display = 'none'
    if(currentUser.email === ADMIN_EMAIL){ adminPanel.style.display = 'block'; fetchSubscriptions() }
    await fetchSubscriptionForUser(currentUser.email)
    formatStatus()
  } else {
    formatStatus()
    showLoginModal()
  }
  await fetchVideos()
})

// --- SUBSCRIPTION (for current user) ---
async function fetchSubscriptionForUser(email){
  subscription = null
  const { data, error } = await supabase
    .from('subscription')
    .select('email, "start date", duration, "end date", courses')
    .eq('email', email.toLowerCase())
    .maybeSingle()
  if(error){ console.error(error); return }
  subscription = data || null
}

// --- VIDEOS ---
async function fetchVideos(){
  const { data, error } = await supabase
    .from('Videos')
    .select('id, title, "video id", "password list", section, semester, order')
    .order('order', { ascending: true })
  if(error){ container.innerHTML = '<b>Failed to load videos.</b>'; console.error(error); return }
  allVideos = data || []
  renderVideos(allVideos)
  if(currentUser?.email === ADMIN_EMAIL){ renderExistingVideos(allVideos) }
}

function renderVideos(videos){
  const grouped = {}
  videos.forEach(v=>{
    const sec = v.section || 'Other'
    const sem = v.semester || 'Other'
    grouped[sec] = grouped[sec] || {}
    grouped[sec][sem] = grouped[sec][sem] || []
    grouped[sec][sem].push(v)
  })

  container.innerHTML = ''
  Object.keys(grouped).sort().forEach(section=>{
    const secDiv = document.createElement('div')
    secDiv.className = 'section'
    secDiv.innerHTML = `<h3>${section}</h3>`

    Object.keys(grouped[section]).sort().forEach(semester=>{
      const semDiv = document.createElement('div')
      semDiv.innerHTML = `<div class="semester-title">${semester}</div>`
      grouped[section][semester].forEach(video=>{
        const card = document.createElement('div')
        const unlocked = canAccessVideo(video)
        card.className = 'video-card'
        card.innerHTML = `<span>${video.title}</span><span class="lock">${unlocked ? '▶️' : '🔒'}</span>`
        card.onclick = ()=> handleVideoClick(video, unlocked)
        semDiv.appendChild(card)
      })
      secDiv.appendChild(semDiv)
    })

    container.appendChild(secDiv)
  })
}

function playVideoById(videoId){
  videoFrame.src = `https://www.youtube.com/embed/${videoId}`
}

async function handleVideoClick(video, unlocked){
  if(unlocked){
    playVideoById(video['video id'])
    return
  }
  // Not subscribed for this section — ask for password
  const pw = prompt('You are not subscribed to this course. Enter password to watch:')
  if(pw===null) return
  const passwords = passwordsFor(video).map(s=>s.toLowerCase())
  if(passwords.includes(pw.trim().toLowerCase())){
    playVideoById(video['video id'])
  } else {
    alert('Incorrect password or access denied.')
  }
}

// --- ADMIN: Video management ---
function renderExistingVideos(data){
  existingVideosDiv.innerHTML = '<h4>Existing Videos</h4>'
  data.forEach(v=>{
    const row = document.createElement('div')
    row.style.borderBottom = '1px solid #eee'
    row.style.padding = '6px 0'
    row.innerHTML = `${v.title} (${v.section} — ${v.semester}) <button class="btn danger" data-id="${v.id}">Delete</button>`
    existingVideosDiv.appendChild(row)
  })
  existingVideosDiv.querySelectorAll('button[data-id]').forEach(btn=>{
    btn.onclick = async ()=>{
      const id = btn.getAttribute('data-id')
      if(!confirm('Delete this video?')) return
      const { error } = await supabase.from('Videos').delete().eq('id', id)
      if(error){ alert(error.message); return }
      fetchVideos()
    }
  })
}

addVideoForm.onsubmit = async (e)=>{
  e.preventDefault()
  if(!currentUser || currentUser.email !== ADMIN_EMAIL) return alert('Admins only.')
  const title = document.getElementById('videoTitle').value.trim()
  const video_id = document.getElementById('videoID').value.trim()
  const password_list = document.getElementById('passwordList').value.trim()
  const section = document.getElementById('videoSection').value
  const semester = document.getElementById('videoSemester').value
  const order = parseInt(document.getElementById('videoOrder').value)
  if(!title || !video_id || !section || !semester || Number.isNaN(order)) return alert('Fill all fields.')

  const { error } = await supabase.from('Videos').insert([{ 
    title,
    'video id': video_id,
    'password list': password_list,
    section,
    semester,
    order
  }])
  if(error){ alert(error.message); return }
  addVideoForm.reset()
  fetchVideos()
}

// --- ADMIN: Subscriptions management ---
async function fetchSubscriptions(){
  const { data, error } = await supabase
    .from('subscription')
    .select('email, "start date", duration, "end date", courses')
    .order('email', { ascending: true })
  if(error){ subscriptionsAdmin.innerHTML = 'Failed to fetch subscriptions.'; console.error(error); return }
  renderSubscriptionsAdmin(data||[])
}

function renderSubscriptionsAdmin(data){
  subscriptionsAdmin.innerHTML = `
    <h4>All Subscriptions</h4>
    <table>
      <tr><th>Email</th><th>Start</th><th>Duration (months)</th><th>End</th><th>Courses</th><th>Action</th></tr>
      ${data.map(sub=>`
        <tr>
          <td>${sub.email}</td>
          <td>${sub['start date']||''}</td>
          <td>${sub.duration||''}</td>
          <td>${sub['end date']||''}</td>
          <td>${sub.courses||''}</td>
          <td>
            <button class="btn ghost" data-edit="${sub.email}">Edit</button>
            <button class="btn danger" data-del="${sub.email}">Delete</button>
          </td>
        </tr>`).join('')}
    </table>
    <h4 style="margin-top:14px">Add / Update Subscription</h4>
    <form id="addSubForm">
      <div class="grid">
        <div><label>Email</label><input type="email" id="subEmail" placeholder="Email" required /></div>
        <div><label>Start Date</label><input type="date" id="subStart" required /></div>
        <div>
          <label>Duration</label>
          <select id="subDuration" required>
            <option value="">Select Duration</option>
            <option value="1">1 Month</option>
            <option value="3">3 Months</option>
            <option value="5">5 Months</option>
          </select>
        </div>
        <div><label>Courses (comma separated; blank = ALL)</label><input type="text" id="subCourses" placeholder="e.g., Maths, Biology" /></div>
      </div>
      <div style="margin-top:10px"><button class="btn" type="submit">Save Subscription</button></div>
    </form>
  `

  // row buttons
  subscriptionsAdmin.querySelectorAll('button[data-edit]').forEach(btn=>{
    btn.onclick = ()=>{
      const email = btn.getAttribute('data-edit')
      const tr = btn.closest('tr')
      document.getElementById('subEmail').value = email
      document.getElementById('subStart').value = tr.children[1].textContent
      document.getElementById('subDuration').value = tr.children[2].textContent
      document.getElementById('subCourses').value = tr.children[4].textContent
    }
  })
  subscriptionsAdmin.querySelectorAll('button[data-del]').forEach(btn=>{
    btn.onclick = async ()=>{
      const email = btn.getAttribute('data-del')
      if(!confirm('Delete subscription for '+email+'?')) return
      const { error } = await supabase.from('subscription').delete().eq('email', email)
      if(error){ alert('Error: '+error.message); return }
      fetchSubscriptions()
    }
  })

  // form submit
  const addForm = document.getElementById('addSubForm')
  addForm.onsubmit = async (e)=>{
    e.preventDefault()
    const email = document.getElementById('subEmail').value.trim().toLowerCase()
    const start = document.getElementById('subStart').value
    const duration = parseInt(document.getElementById('subDuration').value)
    const courses = document.getElementById('subCourses').value.trim()
    if(!email || !start || Number.isNaN(duration)) return alert('Fill required fields.')

    // compute end
    const startDate = new Date(start)
    const endDate = new Date(startDate)
    endDate.setMonth(endDate.getMonth()+duration)
    const endStr = endDate.toISOString().split('T')[0]

    const { error } = await supabase.from('subscription').upsert([{ 
      email,
      'start date': start,
      duration,
      'end date': endStr,
      courses
    }])
    if(error){ alert('Error: '+error.message); return }

    alert('Subscription saved/updated!')
    fetchSubscriptions()
  }
}
</script>
</body>
</html>
