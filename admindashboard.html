<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Thrives Archivers - Documents Dashboard</title>
<style>
  :root{
    --brand:#1976d2; --bg:#f4f4f4; --card:#fff; --danger:#e53935; --muted:#777;
  }
  body{font-family:Arial,sans-serif;background:var(--bg);margin:0;padding:0}
  h2{background:#333;color:#fff;text-align:center;padding:15px;margin:0}
  .topbar{display:flex;justify-content:space-between;align-items:center;padding:10px 16px;background:#222;color:#fff}
  .topbar .left{font-weight:bold}
  .topbar .right{display:flex;gap:8px;align-items:center}
  .pill{background:#111;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #444}
  .btn{cursor:pointer;background:var(--brand);color:#fff;border:none;border-radius:6px;padding:8px 12px}
  .btn.ghost{background:#444}
  .btn.danger{background:var(--danger)}
  .container{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:20px;padding:20px}
  .section{background:var(--card);padding:15px;border-radius:12px;box-shadow:0 0 15px rgba(0,0,0,.08)}
  .section h3{margin-top:0;background:var(--brand);color:#fff;padding:10px;border-radius:6px}
  .semester-title{font-weight:bold;margin-top:10px;color:#333;font-size:14px}
  .doc-card{background:#f1f1f1;padding:10px;margin:8px 0;border-radius:8px;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
  .doc-card:hover{background:#e6e6e6}
  iframe{width:100%;height:500px;border:none;margin-top:10px;border-radius:12px;box-shadow:0 0 15px rgba(0,0,0,.2)}
  .admin-panel{background:#fff;padding:20px;margin:20px auto;width:92%;max-width:1000px;border-radius:12px;box-shadow:0 0 15px rgba(0,0,0,.15);display:none}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
  input, select{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px}
  label{font-size:12px;color:var(--muted)}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid #ddd;padding:8px;text-align:left}
  th{background:#fafafa}
</style>
</head>
<body>
<h2>Thrives Archivers - Documents</h2>

<div class="topbar">
  <div class="left">Welcome, <span id="displayName">Guest</span></div>
  <div class="right">
    <span class="pill" id="subInfo">Not logged in</span>
    <button class="btn" id="loginTopBtn">Login</button>
    <button class="btn ghost" id="logoutBtn" style="display:none">Logout</button>
  </div>
</div>

<div id="statusBar" style="text-align:center;padding:10px;font-weight:bold"></div>

<div class="container" id="container"></div>

<iframe id="docViewer"></iframe>

<!-- Admin Panel -->
<div class="admin-panel" id="adminPanel">
  <h3>Admin Panel â€” Manage Documents & Subscriptions</h3>
  <form id="addDocForm">
    <div class="grid">
      <div><label>Title</label><input type="text" id="docTitle" placeholder="Document Title" required /></div>
      <div><label>Document URL (Google Drive Preview Link)</label><input type="text" id="docURL" placeholder="https://drive.google.com/..." required /></div>
      <div><label>Passwords (comma separated)</label><input type="text" id="docPasswords" placeholder="abc123, xyz789" /></div>
      <div>
        <label>Section</label>
        <select id="docSection" required>
          <option value="">Select Section</option>
          <option>Maths</option>
          <option>Physics</option>
          <option>Chemistry</option>
          <option>Biology</option>
          <option>Anatomy</option>
        </select>
      </div>
      <div>
        <label>Semester / Term</label>
        <select id="docSemester" required>
          <option value="">Select</option>
          <option>Semester One</option>
          <option>Semester Two</option>
          <option>Term One</option>
          <option>Term Two</option>
          <option>Term Three</option>
        </select>
      </div>
    </div>
    <div style="margin-top:10px"><button class="btn" type="submit">Add Document</button></div>
  </form>

  <div id="existingDocs" style="margin-top:16px"></div>
  <hr style="margin:20px 0" />

  <h3>Subscriptions Management</h3>
  <form id="addSubForm">
    <div class="grid">
      <div><label>Email</label><input type="email" id="subEmail" required /></div>
      <div><label>Start Date</label><input type="date" id="subStart" required /></div>
      <div><label>Duration (Months)</label><input type="number" id="subDuration" required /></div>
      <div><label>Courses (comma separated)</label><input type="text" id="subCourses" /></div>
    </div>
    <div style="margin-top:10px"><button class="btn" type="submit">Add/Update Subscription</button></div>
  </form>

  <div id="subscriptionsAdmin" style="margin-top:16px"></div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

// Supabase setup
const supabaseUrl = 'https://odwiqajuubcgrrqipyju.supabase.co'
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9kd2lxYWp1dWJjZ3JycWlweWp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyNzA4MjEsImV4cCI6MjA2ODg0NjgyMX0.CPyCmqvr0QIx3PJUsZkYqRR3nGzG0kHlvStj49_U24A'
const supabase = createClient(supabaseUrl, supabaseKey)

const ADMIN_EMAIL = 'thrivesarchivers@gmail.com'

const container = document.getElementById('container')
const docViewer = document.getElementById('docViewer')
const adminPanel = document.getElementById('adminPanel')
const addDocForm = document.getElementById('addDocForm')
const existingDocs = document.getElementById('existingDocs')
const statusBar = document.getElementById('statusBar')
const loginTopBtn = document.getElementById('loginTopBtn')
const logoutBtn = document.getElementById('logoutBtn')
const displayNameEl = document.getElementById('displayName')
const subInfo = document.getElementById('subInfo')
const subscriptionsAdmin = document.getElementById('subscriptionsAdmin')
const addSubForm = document.getElementById('addSubForm')

let currentUser = null
let subscription = null
let allDocs = []

// Format user and subscription status
function formatStatus(){
  if(!currentUser){ 
    statusBar.textContent='Please login'
    subInfo.textContent='Not logged in'
    displayNameEl.textContent='Guest'
    adminPanel.style.display='none'
    return 
  }
  displayNameEl.textContent=currentUser.email
  subInfo.textContent=subscription? `Subscribed: ${subscription.courses||'All'}` : 'No subscription'
  if(currentUser.email === ADMIN_EMAIL) adminPanel.style.display='block'
}

// Fetch subscription for current user
async function fetchSubscriptionForUser(email){
  const { data } = await supabase.from('subscription').select('*').eq('email', email).single()
  subscription = data || null
  formatStatus()
}

// Fetch all documents
async function fetchDocs(){
  const { data, error } = await supabase.from('documents').select('*').order('id')
  if(error){ container.innerHTML='<b>Failed to load documents.</b>'; return }
  allDocs = data || []
  renderDocs(allDocs)
}

// Render documents on dashboard
function renderDocs(docs){
  const grouped = {}
  docs.forEach(d=>{
    const sec = d.section || 'Other', sem = d.semester || 'Other'
    grouped[sec] = grouped[sec]||{}
    grouped[sec][sem] = grouped[sec][sem]||[]
    grouped[sec][sem].push(d)
  })
  container.innerHTML = ''
  Object.keys(grouped).sort().forEach(section=>{
    const secDiv = document.createElement('div'); secDiv.className='section'
    secDiv.innerHTML = `<h3>${section}</h3>`
    Object.keys(grouped[section]).sort().forEach(sem=>{
      const semDiv = document.createElement('div')
      semDiv.innerHTML=`<div class="semester-title">${sem}</div>`
      grouped[section][sem].forEach(d=>{
        const card = document.createElement('div'); card.className='doc-card'
        const unlocked = currentUser?.email===ADMIN_EMAIL || !d['password list']
        card.innerHTML=`<span>${d.title}</span><span>${unlocked?'ðŸ“„':'ðŸ”’'}</span>`
        card.onclick=()=> handleDocClick(d, unlocked)
        semDiv.appendChild(card)
      })
      secDiv.appendChild(semDiv)
    })
    container.appendChild(secDiv)
  })
}

// Handle document click
function passwordsFor(doc){ return (doc['password list']||'').split(',').map(s=>s.trim().toLowerCase()) }
function handleDocClick(doc, unlocked){
  if(unlocked){ docViewer.src=doc.url; return }
  const pw = prompt('Enter password:'); if(!pw) return
  if(passwordsFor(doc).includes(pw.toLowerCase())) docViewer.src=doc.url
  else alert('Incorrect password!')
}

// Login/logout handlers
loginTopBtn.onclick = async ()=>{
  const { data, error } = await supabase.auth.signInWithOtp({ email: prompt('Enter email:') })
  if(error) return alert(error.message)
  alert('Check your email for login link.')
}
logoutBtn.onclick = async ()=>{
  await supabase.auth.signOut()
  currentUser=null
  subscription=null
  formatStatus()
}

// Track auth state
supabase.auth.onAuthStateChange(async (event, session)=>{
  currentUser = session?.user || null
  if(currentUser) await fetchSubscriptionForUser(currentUser.email)
  formatStatus()
})

// Add document
addDocForm.onsubmit = async e=>{
  e.preventDefault()
  if(currentUser.email !== ADMIN_EMAIL) return alert('Not allowed')
  const title = document.getElementById('docTitle').value
  const url = document.getElementById('docURL').value
  const passwords = document.getElementById('docPasswords').value
  const section = document.getElementById('docSection').value
  const semester = document.getElementById('docSemester').value
  const { error } = await supabase.from('documents').insert([{title,url,'password list':passwords,section,semester}])
  if(error) return alert(error.message)
  addDocForm.reset()
  fetchDocs()
}

// Add/update subscription
addSubForm.onsubmit = async e=>{
  e.preventDefault()
  const email = document.getElementById('subEmail').value.trim().toLowerCase()
  const start = document.getElementById('subStart').value
  const duration = parseInt(document.getElementById('subDuration').value)
  const courses = document.getElementById('subCourses').value.trim()
  if(!email || !start || isNaN(duration)) return alert('Fill all fields')
  const startDate = new Date(start)
  const endDate = new Date(startDate)
  endDate.setMonth(endDate.getMonth() + duration)
  const endDateStr = endDate.toISOString().split('T')[0]
  const { error } = await supabase.from('subscription').upsert([{email,"start date":start,duration,"end date":endDateStr,courses}],{onConflict:['email']})
  if(error) return alert(error.message)
  addSubForm.reset()
  fetchSubscriptionForUser(email)
}

// Initial fetch
fetchDocs()
</script>
</body>
</html>
