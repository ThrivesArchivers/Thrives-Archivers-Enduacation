<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Thrives Archivers Course Access</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Supabase JS (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; }
  header { background-color: #333; color: #fff; text-align: center; padding: 10px; }
  header img { width: 100%; max-height: 250px; object-fit: cover; }
  .topbar { display:flex; justify-content: flex-end; align-items:center; gap:12px; padding:10px 20px; background:#fff; box-shadow:0 1px 4px rgba(0,0,0,0.06);}
  .topbar .user-info { font-size:14px; color:#333; }
  .container { max-width: 1200px; margin: auto; padding: 20px; }
  .course-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
  .course-card { background: #fff; padding: 15px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
  .course-card h3 { margin-top: 0; }
  .course-card ul { list-style: none; padding-left: 0; }
  .course-card li { margin-bottom: 12px; display: flex; flex-direction: column; gap: 5px; }
  .icon { font-size: 18px; }
  .doc-link { text-decoration: none; color: #007BFF; cursor: pointer; }
  .doc-link:hover { text-decoration: underline; }
  .take-quiz-btn {
    display: inline-block;
    margin-top: 4px;
    padding: 8px 16px;
    background-color: #e0e0e0;
    color: #333;
    border-radius: 5px;
    font-size: 14px;
    text-decoration: none;
    border: 1px solid #ccc;
  }
  .take-quiz-btn:hover { background-color: #d5d5d5; }
  .free-quiz-btn {
    display: inline-block;
    margin-top: 10px;
    padding: 12px 20px;
    background: linear-gradient(90deg, #ff7e5f, #feb47b);
    color: #fff;
    border-radius: 6px;
    font-size: 16px;
    font-weight: bold;
    text-decoration: none;
    border: none;
    cursor: pointer;
    transition: transform 0.2s;
  }
  .free-quiz-btn:hover { transform: scale(1.05); }
  .whatsapp-button {
    display: inline-block;
    margin-top: 10px;
    padding: 12px 20px;
    background-color: #25D366;
    color: #fff;
    border-radius: 6px;
    font-size: 16px;
    font-weight: bold;
    text-decoration: none;
    position: relative;
  }
  .whatsapp-button .chat-icon {
    display: inline-block;
    margin-left: 8px;
    animation: moveIcon 1s infinite alternate;
  }
  @keyframes moveIcon {
    0% { transform: translateY(0); }
    100% { transform: translateY(-5px); }
  }
  .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); }
  .modal-content { background-color: #fff; margin: 5% auto; width: 90%; max-width: 800px; border-radius: 10px; overflow: hidden; position: relative; }
  .modal-content iframe { width: 100%; height: 500px; border: none; }
  .close-btn { position: absolute; top: 5px; right: 10px; font-size: 24px; color: #333; cursor: pointer; font-weight: bold; }
  /* Admin panel */
  .admin-panel { background:#fff; padding:12px; border-radius:8px; box-shadow:0 0 8px rgba(0,0,0,0.08); margin-bottom:20px;}
  .form-row { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px; }
  .form-row input, .form-row select { padding:8px; border-radius:6px; border:1px solid #ccc; }
  .btn { padding:8px 12px; border-radius:6px; border:none; cursor:pointer; }
  .btn-primary { background:#007bff;color:#fff; }
  .btn-danger { background:#dc3545;color:#fff; }
  .status-enrolled { color:green; font-weight:bold; }
  .status-not { color:red; font-weight:bold; }
  /* small screens improvements */
  @media (max-width:600px){ .topbar{flex-direction:column;align-items:flex-start;} }
</style>
</head>
<body>
<header>
  <!-- Keep same header image as requested -->
  <img src="file_0000000009d461f89d0cb3387f0b7000.png" alt="Header Image">
  <h1>Thrives Archivers Course Access</h1>
</header>
<!-- Topbar: will show user email and enrollment status -->
<div class="topbar">
  <div class="user-info" id="userInfo">Not signed in</div>
  <div id="authButtons">
    <button class="btn btn-primary" id="signInBtn">Sign in</button>
    <button class="btn" id="signOutBtn" style="display:none;">Sign out</button>
  </div>
</div>
<div class="container">

  <!-- Admin panel (hidden unless admin) -->
  <div id="adminPanel" class="admin-panel" style="display:none;">
    <h3>Admin Panel â€” Add Anatomy Content</h3>
    <div style="font-size:13px; color:#555; margin-bottom:8px;">Add videos, notes (drive preview links), or quiz pages (local html). Visible only to <strong>thrivesarchivers@gmail.com</strong>.</div>
    <div class="form-row">
      <select id="adminSection">
        <option value="Anatomy">Anatomy</option>
        <option value="Physiology">Physiology</option>
        <option value="Public Health">Public Health</option>
        <option value="Medical Biochemical">Medical Biochemical</option>
        <option value="Behavioral">Behavioral Science</option>
      </select>
      <input id="adminTitle" placeholder="Title (e.g., Anatomy of a Hand)" style="flex:1;">
    </div>
    <div class="form-row">
      <select id="adminType">
        <option value="note">Note (Google Drive preview link)</option>
        <option value="video">Video (YouTube link)</option>
        <option value="quiz">Quiz (local html page like Historogy1.html)</option>
      </select>
      <input id="adminUrl" placeholder="URL (drive preview / youtube / local html path)" style="flex:1;">
      <input id="adminOrder" placeholder="Order (number)" style="width:100px;">
    </div>
    <div style="display:flex; gap:8px;">
      <button class="btn btn-primary" id="addContentBtn">Add content</button>
      <button class="btn btn-danger" id="refreshContentBtn">Refresh content</button>
    </div>
    <div id="adminMsg" style="margin-top:8px; font-size:13px;"></div>
  </div>

  <div class="course-grid" id="courseGrid">
    <!-- initial static cards will be replaced by dynamic content from Supabase, but we preserve the layout -->
    <!-- When content loads, this area will be filled with section cards -->
  </div>
  <a class="free-quiz-btn" href="anatomyquize.html" target="_blank">Go to Anatomy Quiz</a>
  <a class="whatsapp-button" href="https://wa.me/260973178100" target="_blank">
    Chat with Me on WhatsApp <span class="chat-icon">ðŸ’¬</span>
  </a>

</div>
<!-- Modal -->
<div id="modal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal()">&times;</span>
    <iframe id="viewerFrame" src=""></iframe>
  </div>
</div>
<script>
/* ================== Supabase config - REPLACE these with your project values ==================
   Get these from your Supabase project settings.
   SUPABASE_URL example: https://abcxyz.supabase.co
   SUPABASE_ANON_KEY is the anon/public key (do not use service_role key on client)
============================================================================================= */
const SUPABASE_URL = 'https://SUPABASE_URL';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9kd2lxYWp1dWJjZ3JycWlweWp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyNzA4MjEsImV4cCI6MjA2ODg0NjgyMX0.CPyCmqvr0QIx3PJUsZkYqRR3nGzG0kHlvStj49_U24A';

/* Note: the CDN exposes a global called `supabase` utilities; many examples use `createClient`.
   The original code used `supabaseJs.createClient`. Keep whichever works for your CDN build.
   If you see a 'supabaseJs is not defined' error in console, replace `supabaseJs.createClient` with `createClient`.
*/
const supabase = (typeof supabaseJs !== 'undefined')
  ? supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
  : (typeof createClient !== 'undefined')
    ? createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    : (() => { console.error('Supabase client not found. Check CDN import.'); return null; })();

/* Protect this page? If true, users who are not authenticated will be redirected to login.html
   after we attempt to restore session from URL or listen for auth state changes. */
const REQUIRE_AUTH = true;

/* Admin email (as requested) */
const ADMIN_EMAIL = 'thrivesarchivers@gmail.com';

/* DOM refs */
const userInfoEl = document.getElementById('userInfo');
const signInBtn = document.getElementById('signInBtn');
const signOutBtn = document.getElementById('signOutBtn');
const adminPanel = document.getElementById('adminPanel');
const adminMsg = document.getElementById('adminMsg');
const courseGrid = document.getElementById('courseGrid');
const addContentBtn = document.getElementById('addContentBtn');
const refreshContentBtn = document.getElementById('refreshContentBtn');

function showModalWith(link) {
  document.getElementById('viewerFrame').src = link;
  document.getElementById('modal').style.display = 'block';
}
function closeModal() {
  document.getElementById('modal').style.display = 'none';
  document.getElementById('viewerFrame').src = '';
}
window.onclick = function(event) {
  const modal = document.getElementById('modal');
  if (event.target == modal) { closeModal(); }
}

/* ---------- Authentication ---------- */

/* Redirect to login page when user clicks sign-in */
signInBtn.addEventListener('click', () => {
  window.location.href = "login.html"; // Redirect to login page
});

/* Sign out */
signOutBtn.addEventListener('click', async () => {
  if (!supabase) return;
  await supabase.auth.signOut();
  location.reload();
});

/* On page load: robust session handling:
   - Try to parse session returned in URL (handles magic-link / OAuth redirects)
   - Then check current session
   - Register onAuthStateChange to handle async auth changes
   - Only redirect to login.html if REQUIRE_AUTH is true and no session after attempts
*/
async function init() {
  if (!supabase) {
    console.error('Supabase client not initialized');
    return;
  }

  try {
    // Try to handle session from a redirect (magic link / OAuth). This will store session if present.
    // If your flow does not use redirects, this call will simply return null/no-op.
    await supabase.auth.getSessionFromUrl().catch(() => null);
  } catch (err) {
    // ignore - older clients or flows may not support it
    console.debug('getSessionFromUrl not available or failed:', err);
  }

  // Listen for auth state changes (important for cross-tab / redirect flows)
  supabase.auth.onAuthStateChange((event, session) => {
    if (session && session.user) {
      onAuthChange(session.user);
    } else {
      // If user signs out, show signed-out state (we won't redirect here; init handles redirect decision)
      showSignedOut();
    }
  });

  // Get current session
  const { data: { session } } = await supabase.auth.getSession();

  if (session && session.user) {
    onAuthChange(session.user);
  } else {
    // Give the client a very short moment to process possible redirect events (if any).
    // This reduces race conditions where a redirect-set session hasn't been applied yet.
    await new Promise(res => setTimeout(res, 500));

    // re-check session
    const { data: { session: session2 } } = await supabase.auth.getSession();
    if (session2 && session2.user) {
      onAuthChange(session2.user);
    } else {
      if (REQUIRE_AUTH) {
        // user is not signed in â€” redirect to login page
        window.location.href = "login.html";
        return;
      } else {
        showSignedOut();
      }
    }
  }

  // Load content regardless (if admin-only features depend on auth they'll hide automatically)
  await fetchAndRenderContent();
}

/* When user authenticated */
async function onAuthChange(user) {
  if (!user) return;
  const email = user.email || '(no-email)';
  userInfoEl.innerHTML = `Signed in as <strong>${escapeHtml(email)}</strong> â€” <span id="enrollStatus">Checking enrollment...</span>`;
  signInBtn.style.display = 'none';
  signOutBtn.style.display = 'inline-block';

  // Show admin panel only for admin email
  if (email === ADMIN_EMAIL) {
    adminPanel.style.display = 'block';
  } else {
    adminPanel.style.display = 'none';
  }

  // Check subscription status from subscription table
  const { data, error } = await supabase
    .from('subscription')
    .select('*')
    .eq('email', email)
    .order('start_date', { ascending: false })
    .limit(1);

  const enrollEl = document.getElementById('enrollStatus');
  if (!enrollEl) return;
  if (error) {
    enrollEl.innerText = 'Error fetching subscription';
    enrollEl.className = 'status-not';
    console.error(error);
  } else if (data && data.length > 0) {
    const sub = data[0];
    let now = new Date();
    let endDate = sub.end_date ? new Date(sub.end_date) : null;
    if (!endDate && sub.start_date && sub.duration) {
      endDate = new Date(sub.start_date);
      endDate.setDate(endDate.getDate() + Number(sub.duration));
    }
    if (endDate && now <= endDate) {
      enrollEl.innerText = 'ENROLLED';
      enrollEl.className = 'status-enrolled';
    } else {
      enrollEl.innerText = 'NOT ENROLLED';
      enrollEl.className = 'status-not';
    }
  } else {
    enrollEl.innerText = 'NOT ENROLLED';
    enrollEl.className = 'status-not';
  }
}

/* When signed out */
function showSignedOut() {
  userInfoEl.innerHTML = 'Not signed in';
  signInBtn.style.display = 'inline-block';
  signOutBtn.style.display = 'none';
  adminPanel.style.display = 'none';
  // still render public/free content
}

/* ---------- Content fetching + rendering ---------- */
async function fetchAndRenderContent() {
  if (!supabase) {
    courseGrid.innerHTML = '<div style="color:red">Supabase client not initialized.</div>';
    return;
  }

  const { data, error } = await supabase
    .from('anatomy')
    .select('*')
    .order('section', { ascending: true })
    .order('order', { ascending: true });

  if (error) {
    console.error('Error fetching anatomy:', error);
    courseGrid.innerHTML = '<div style="color:red">Failed to load content from Supabase.</div>';
    return;
  }

  const groups = {};
  (data || []).forEach(item => {
    const section = item.section || 'General';
    if (!groups[section]) groups[section] = [];
    groups[section].push(item);
  });

  courseGrid.innerHTML = '';
  for (const section of Object.keys(groups)) {
    const items = groups[section];
    const card = document.createElement('div');
    card.className = 'course-card';
    card.innerHTML = `<h3>${escapeHtml(section)}</h3>`;
    const ul = document.createElement('ul');

    items.forEach(it => {
      const li = document.createElement('li');
      let title = escapeHtml(it.title || '(no title)');
      if (it.type === 'note') {
        const a = document.createElement('a');
        a.className = 'doc-link';
        a.href = '#';
        a.textContent = 'ðŸ“„ ' + title;
        a.addEventListener('click', (e) => { e.preventDefault(); showModalWith(it.url); });
        li.appendChild(a);
      } else if (it.type === 'video') {
        const a = document.createElement('a');
        a.className = 'doc-link';
        a.href = '#';
        a.textContent = 'ðŸŽ¬ ' + title;
        a.addEventListener('click', (e) => { e.preventDefault(); const embed = youtubeEmbedFromUrl(it.url); showModalWith(embed || it.url); });
        li.appendChild(a);
      } else if (it.type === 'quiz') {
        const a = document.createElement('a');
        a.className = 'doc-link';
        a.href = '#';
        a.textContent = 'ðŸ“ ' + title;
        a.addEventListener('click', (e) => { e.preventDefault(); showModalWith(it.url); });
        li.appendChild(a);
      } else {
        const a = document.createElement('a');
        a.className = 'doc-link';
        a.href = '#';
        a.textContent = 'ðŸ”— ' + title;
        a.addEventListener('click', (e) => { e.preventDefault(); showModalWith(it.url); });
        li.appendChild(a);
      }

      const actions = document.createElement('div');
      actions.style.display = 'flex';
      actions.style.gap = '8px';
      actions.style.marginTop = '6px';

      if (it.type === 'video') {
        const vidBtn = document.createElement('a');
        vidBtn.className = 'take-quiz-btn';
        vidBtn.href = '#';
        vidBtn.textContent = 'ðŸŽ¥ Video';
        vidBtn.addEventListener('click', (e) => { e.preventDefault(); const embed = youtubeEmbedFromUrl(it.url); showModalWith(embed || it.url); });
        actions.appendChild(vidBtn);
      }

      if (it.type === 'quiz') {
        const qBtn = document.createElement('a');
        qBtn.className = 'take-quiz-btn';
        qBtn.href = '#';
        qBtn.textContent = 'ðŸ“ Quiz';
        qBtn.addEventListener('click', (e) => { e.preventDefault(); showModalWith(it.url); });
        actions.appendChild(qBtn);
      }

      if (it.type === 'note') {
        const nBtn = document.createElement('a');
        nBtn.className = 'take-quiz-btn';
        nBtn.href = '#';
        nBtn.textContent = 'ðŸ“„ Note';
        nBtn.addEventListener('click', (e) => { e.preventDefault(); showModalWith(it.url); });
        actions.appendChild(nBtn);
      }

      li.appendChild(actions);
      ul.appendChild(li);
    });

    card.appendChild(ul);
    courseGrid.appendChild(card);
  }

  if (!data || data.length === 0) {
    courseGrid.innerHTML = `<div class="course-card"><h3>No content yet</h3><p>Admin can add content from the admin panel.</p></div>`;
  }
}

/* Helper to produce youtube embed url from many formats */
function youtubeEmbedFromUrl(url) {
  if (!url) return null;
  const ytShort = /youtu\.be\/([a-zA-Z0-9_\-]+)/;
  const ytWatch = /v=([a-zA-Z0-9_\-]+)/;
  const ytEmbed = /youtube\.com\/embed\/([a-zA-Z0-9_\-]+)/;
  let id = null;
  if (ytEmbed.test(url)) {
    id = url.match(ytEmbed)[1];
  } else if (ytShort.test(url)) {
    id = url.match(ytShort)[1];
  } else if (ytWatch.test(url)) {
    id = url.match(ytWatch)[1];
  } else {
    return url;
  }
  return `https://www.youtube.com/embed/${id}`;
}

/* Escape helper */
function escapeHtml(unsafe) {
  if (!unsafe) return '';
  return unsafe.replace(/[&<"'>]/g, function(m){ return {'&':'&amp;','<':'&lt;','"':'&quot;',"'":'&#039;', '>':'&gt;'}[m]; });
}

/* ---------- Admin: Add content ---------- */
addContentBtn.addEventListener('click', async () => {
  if (!supabase) return;
  const session = (await supabase.auth.getSession()).data.session;
  if (!session || !session.user || session.user.email !== ADMIN_EMAIL) {
    adminMsg.innerText = 'Only admin can add content. Sign in as admin.';
    return;
  }
  const section = document.getElementById('adminSection').value;
  const title = document.getElementById('adminTitle').value.trim();
  const type = document.getElementById('adminType').value;
  const url = document.getElementById('adminUrl').value.trim();
  const order = parseInt(document.getElementById('adminOrder').value || '999');

  if (!title || !url) {
    adminMsg.innerText = 'Title and URL are required.';
    return;
  }
  adminMsg.innerText = 'Adding...';
  const { data, error } = await supabase
    .from('anatomy')
    .insert([{ section, title, type, url, order }]);

  if (error) {
    adminMsg.innerText = 'Insert failed: ' + error.message;
    console.error(error);
  } else {
    adminMsg.innerText = 'Added successfully.';
    document.getElementById('adminTitle').value = '';
    document.getElementById('adminUrl').value = '';
    document.getElementById('adminOrder').value = '';
    await fetchAndRenderContent();
  }
});

/* Refresh button */
refreshContentBtn.addEventListener('click', fetchAndRenderContent);

/* Init on load */
init();

</script>
</script>
<!-- =========================
  Supabase Table SQL + Suggestions
  =========================

Run these in Supabase SQL editor to create the `anatomy` table.

-- Suggested anatomy table:
create table public.anatomy (
  id bigserial primary key,
  section text not null,      -- e.g., "Anatomy", "Physiology"
  title text not null,        -- e.g., "Anatomy of a Hand"
  type text not null,         -- 'note' | 'video' | 'quiz'
  url text not null,          -- drive preview link, youtube link, or local page path (e.g., 'Historogy1.html')
  "order" integer default 1000,
  created_at timestamptz default now()
);

-- Example insert:
insert into public.anatomy (section, title, type, url, "order") values
('Anatomy', 'Anatomy of a Hand', 'note', 'https://drive.google.com/file/d/FILE_ID/preview', 1),
('Anatomy', 'Forearm Easy Notes (video)', 'video', 'https://www.youtube.com/watch?v=9WL_Ds8konc', 2),
('Anatomy', 'Cell structure and Cell Division Quiz', 'quiz', 'Historogy1.html', 3);

-- Existing subscription table (you said you already created it). Recommended columns:
-- subscription(email text primary key, start_date date, duration integer, end_date date, courses text, created_at timestamptz default now())
-- You can store courses as comma-separated or JSON (jsonb recommended).
-- Example subscription record:
-- insert into subscription (email, start_date, duration, end_date, courses) values ('student@example.com', '2025-10-01', 30, '2025-10-31', 'Anatomy,Physiology');

Notes:
- The front-end code queries `subscription` for the user's email and tries to determine enrollment using `end_date` or start_date + duration.
- Admin panel will appear for thrivesarchivers@gmail.com when that user is signed in.
- For video embedding, provide either a YouTube watch link (https://www.youtube.com/watch?v=ID) or a youtu.be short link. The site will convert it to an embed URL.
- For drive notes, prefer Google Drive preview links (they open cleanly inside the iframe). Example preview pattern: https://drive.google.com/file/d/FILE_ID/preview

-- Security note:
- Use the anon key on client; do NOT embed the service_role key in client code.
- Lock down Row Level Security (RLS) if desired, or keep table public for reads and restrict inserts to authenticated users (you can write policies in Supabase so only admin can insert).
-- Recommended quick RLS policy for admin inserts:
   1) enable RLS for anatomy table
   2) create a policy allowing inserts only if auth.uid() corresponds to a row in a 'users' table with admin=true OR check current_setting('request.jwt.claims.email') = 'thrivesarchivers@gmail.com'
   (Supabase docs have examples for email-based policies.)

===================================== -->
</body>
</body>
</html>
