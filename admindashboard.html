<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Thrives Archivers - Video Streaming</title>
<style>
body { font-family: Arial, sans-serif; background:#f4f4f4; margin:0; text-align:center; }
h2 { background:#333; color:white; padding:15px; margin:0; }
.container { display:flex; flex-wrap:wrap; justify-content:space-around; padding:20px; }
.section { width:45%; background:white; padding:15px; margin:10px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
.section h3 { margin-top:0; background:#444; color:white; padding:10px; }
ul { list-style:none; padding:0; }
li { padding:10px; margin:5px 0; background:#ddd; border-radius:5px; cursor:pointer; }
li:hover { background:#bbb; }
.video-player { margin:20px auto; width:90%; height:300px; }
iframe { width:100%; height:100%; border:none; }
.semester-title { font-weight:bold; margin-top:10px; color:#333; }
.admin-panel { background:#fff; padding:15px; margin:20px auto; width:90%; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.2); display:none; text-align:left; }
.admin-panel h3 { margin-top:0; }
.admin-panel input, .admin-panel select { width:100%; margin:5px 0; padding:8px; }
.admin-panel button { margin-top:10px; padding:10px 15px; cursor:pointer; background:#1976d2; color:white; border:none; border-radius:5px; }
.admin-panel button:hover { background:#125ea3; }
.delete-btn { background:red; margin-top:5px; color:white; padding:5px 10px; border:none; border-radius:5px; cursor:pointer; }
</style>
</head>
<body>

<h2>Thrives Archivers - Video Streaming</h2>

<button id="adminLoginBtn">Admin Login</button>

<div class="container" id="container"></div>

<div class="video-player">
  <iframe id="videoFrame" src="" allowfullscreen></iframe>
</div>

<!-- Admin Panel -->
<div class="admin-panel" id="adminPanel">
  <h3>Admin Panel - Manage Videos</h3>
  <form id="addVideoForm">
    <input type="text" id="videoTitle" placeholder="Video Title" required>
    <input type="text" id="videoID" placeholder="YouTube Video ID" required>
    <input type="text" id="passwordList" placeholder="Passwords (comma separated)" required>
    <select id="videoSection" required>
      <option value="">Select Section</option>
      <option value="Maths">Maths</option>
      <option value="Physics">Physics</option>
      <option value="Chemistry">Chemistry</option>
      <option value="Biology">Biology</option>
    </select>
    <select id="videoSemester" required>
      <option value="">Select Semester</option>
      <option value="First Semester">First Semester</option>
      <option value="Second Semester">Second Semester</option>
    </select>
    <input type="number" id="videoOrder" placeholder="Order (number)" required>
    <button type="submit">Add Video</button>
  </form>
  <div id="existingVideos"></div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const supabaseUrl = 'https://odwiqajuubcgrrqipyju.supabase.co'
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9kd2lxYWp1dWJjZ3JycWlweWp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyNzA4MjEsImV4cCI6MjA2ODg0NjgyMX0.CPyCmqvr0QIx3PJUsZkYqRR3nGzG0kHlvStj49_U24A'
const supabase = createClient(supabaseUrl, supabaseKey)

const container = document.getElementById('container')
const videoFrame = document.getElementById('videoFrame')
const adminPanel = document.getElementById('adminPanel')
const adminLoginBtn = document.getElementById('adminLoginBtn')
const addVideoForm = document.getElementById('addVideoForm')
const existingVideosDiv = document.getElementById('existingVideos')

// ------------------- Admin Login -------------------
adminLoginBtn.onclick = () => {
  const input = prompt("Enter admin password:")
  const adminPassword = "Admin123!" // change in production
  if(input === adminPassword) {
    adminPanel.style.display = 'block'
    alert("Welcome Admin!")
    fetchVideos()
  } else {
    alert("Incorrect password!")
  }
}

// ------------------- Fetch & Render Videos -------------------
async function fetchVideos() {
  const { data, error } = await supabase
    .from('Videos') // Matches your table name
    .select('*')
    .order('section')
    .order('semester')
    .order('order')
  if(error) return console.error(error)
  renderVideos(data)
  if(adminPanel.style.display === 'block') renderExistingVideos(data)
}

function renderVideos(data) {
  container.innerHTML = ''
  const sections = {}
  data.forEach(v => {
    if(!sections[v.section]) sections[v.section] = {}
    if(!sections[v.section][v.semester]) sections[v.section][v.semester] = []
    sections[v.section][v.semester].push(v)
  })

  for(const [sectionName, semesters] of Object.entries(sections)) {
    const sectionDiv = document.createElement('div')
    sectionDiv.className = 'section'
    const h3 = document.createElement('h3')
    h3.textContent = sectionName
    sectionDiv.appendChild(h3)

    for(const [semester, videos] of Object.entries(semesters)) {
      const semTitle = document.createElement('div')
      semTitle.className = 'semester-title'
      semTitle.textContent = semester
      sectionDiv.appendChild(semTitle)

      const ul = document.createElement('ul')
      videos.forEach(v => {
        const li = document.createElement('li')
        li.textContent = v.title
        li.onclick = () => playVideoWithPassword(v['video id'], v['password list'])
        ul.appendChild(li)
      })
      sectionDiv.appendChild(ul)
    }

    container.appendChild(sectionDiv)
  }
}

// ------------------- Play Video -------------------
function playVideoWithPassword(videoId, passwordStr) {
  const passwords = passwordStr.split(',').map(p => p.trim().toLowerCase())
  const input = prompt("Enter video password:")?.trim().toLowerCase()
  if(input && passwords.includes(input)) {
    videoFrame.src = ''
    setTimeout(() => {
      videoFrame.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0&modestbranding=1`
    }, 50)
  } else {
    alert("Incorrect password!")
  }
}

// ------------------- Admin Panel Functions -------------------
addVideoForm.onsubmit = async (e) => {
  e.preventDefault()
  const title = document.getElementById('videoTitle').value
  const video_id = document.getElementById('videoID').value
  const password_list = document.getElementById('passwordList').value
  const section = document.getElementById('videoSection').value
  const semester = document.getElementById('videoSemester').value
  const order = parseInt(document.getElementById('videoOrder').value)

  const { error } = await supabase.from('Videos')
    .insert([{title, 'video id': video_id, 'password list': password_list, section, semester, order}])
  if(error) return console.error(error)
  addVideoForm.reset()
  fetchVideos()
}

// Render existing videos for admin edit/delete
function renderExistingVideos(data) {
  existingVideosDiv.innerHTML = '<h4>Existing Videos:</h4>'
  data.forEach(v => {
    const div = document.createElement('div')
    div.style.borderBottom = "1px solid #ccc"
    div.style.marginBottom = "5px"
    div.style.paddingBottom = "5px"
    div.innerHTML = `
      ${v.title} (${v.section} - ${v.semester})
      <button class="delete-btn" data-id="${v.id}">Delete</button>
    `
    existingVideosDiv.appendChild(div)
  })

  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.onclick = async () => {
      const id = btn.getAttribute('data-id')
      const { error } = await supabase.from('Videos')
        .delete()
        .eq('id', id)
      if(error) return console.error(error)
      fetchVideos()
    }
  })
}

// Initial fetch
fetchVideos()
</script>

</body>
</html>
