<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Thrives Archivers - Video Streaming</title>
<style>
/* ... (existing styles unchanged) ... */
body { font-family: Arial, sans-serif; background:#f4f4f4; margin:0; }
h2 { background:#333; color:white; padding:15px; margin:0; text-align:center; }
.status-bar { margin:10px auto; padding:10px; font-weight:bold; text-align:center; }
.container { display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:20px; padding:20px; }
.section { background:white; padding:15px; border-radius:10px; box-shadow:0 0 15px rgba(0,0,0,0.1); }
.section h3 { margin-top:0; background:#1976d2; color:white; padding:10px; border-radius:5px; }
.semester-title { font-weight:bold; margin-top:10px; color:#333; font-size:14px; }
.video-card { background:#eee; padding:10px; margin:8px 0; border-radius:5px; cursor:pointer; transition:0.3s; }
.video-card:hover { background:#ddd; }
.video-player { margin:20px auto; width:90%; max-width:800px; height:450px; border-radius:10px; overflow:hidden; box-shadow:0 0 15px rgba(0,0,0,0.2); }
iframe { width:100%; height:100%; border:none; }
.admin-panel { background:#fff; padding:20px; margin:20px auto; width:90%; border-radius:10px; box-shadow:0 0 15px rgba(0,0,0,0.2); display:none; }
.admin-panel h3 { margin-top:0; }
.admin-panel input, .admin-panel select { width:100%; margin:5px 0; padding:8px; }
.admin-panel button { margin-top:10px; padding:10px 15px; cursor:pointer; background:#1976d2; color:white; border:none; border-radius:5px; }
.admin-panel button:hover { background:#125ea3; }
.delete-btn { background:red; margin-top:5px; color:white; padding:5px 10px; border:none; border-radius:5px; cursor:pointer; }
.login-modal, .modal-bg { display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; z-index:1000; }
.modal-bg { background:rgba(0,0,0,0.3); }
.login-modal { z-index:1001; left:50%; top:50%; transform:translate(-50%,-50%); background:#fff; padding:30px; border-radius:10px; width:90%; max-width:350px; box-shadow:0 2px 20px #2224; }
.login-modal input { margin:10px 0; width:100%; padding:10px; }
.login-modal button { padding:8px 15px; margin-top:5px; }
</style>
</head>
<body>
<h2>Thrives Archivers - Video Streaming</h2>
<div class="status-bar" id="statusBar"></div>

<!-- Login Modal -->
<div class="modal-bg" id="modalBg"></div>
<div class="login-modal" id="loginModal">
  <h3>Login to your account</h3>
  <input type="email" id="loginEmail" placeholder="Your Email" required>
  <input type="password" id="loginPassword" placeholder="Your Password" required>
  <button id="loginBtn">Login</button>
  <button style="background:#888;" id="closeModalBtn">Cancel</button>
</div>

<div class="container" id="container"></div>

<div class="video-player">
  <iframe id="videoFrame" src="" allowfullscreen></iframe>
</div>

<!-- Admin Panel -->
<div class="admin-panel" id="adminPanel">
  <h3>Admin Panel - Manage Videos & Access</h3>
  <form id="addVideoForm">
    <input type="text" id="videoTitle" placeholder="Video Title" required>
    <input type="text" id="videoID" placeholder="YouTube Video ID" required>
    <input type="text" id="passwordList" placeholder="Passwords (comma separated)" required>
    <select id="videoSection" required>
      <option value="">Select Section</option>
      <option value="Maths">Maths</option>
      <option value="Physics">Physics</option>
      <option value="Chemistry">Chemistry</option>
      <option value="Biology">Biology</option>
    </select>
    <select id="videoSemester" required>
      <option value="">Select Semester</option>
      <option value="First Semester">First Semester</option>
      <option value="Second Semester">Second Semester</option>
    </select>
    <input type="number" id="videoOrder" placeholder="Order (number)" required>
    <button type="submit">Add Video</button>
  </form>
  <div id="existingVideos"></div>
  <hr>
  <h3>Subscriptions Controls</h3>
  <div id="subscriptionsAdmin"></div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

// --- SUPABASE CONFIG ---
const supabaseUrl = 'https://odwiqajuubcgrrqipyju.supabase.co'
const supabaseKey = 'YOUR_SUPABASE_ANON_KEY'  // <-- Replace with your anon/public key from Supabase
const supabase = createClient(supabaseUrl, supabaseKey)

// --- ELEMENTS ---
const container = document.getElementById('container')
const videoFrame = document.getElementById('videoFrame')
const adminPanel = document.getElementById('adminPanel')
const addVideoForm = document.getElementById('addVideoForm')
const existingVideosDiv = document.getElementById('existingVideos')
const statusBar = document.getElementById('statusBar')
const loginModal = document.getElementById('loginModal')
const modalBg = document.getElementById('modalBg')
const closeModalBtn = document.getElementById('closeModalBtn')
const loginBtn = document.getElementById('loginBtn')
const loginEmail = document.getElementById('loginEmail')
const loginPassword = document.getElementById('loginPassword')
const subscriptionsAdmin = document.getElementById('subscriptionsAdmin')

let currentUser = null
let allVideos = []

// --- ENSURE SUBSCRIPTION FOR USER ---
async function ensureSubscription(email) {
  // Check if user already has a subscription
  const { data, error } = await supabase.from('subscription').select('email').eq('email', email).single();
  if (!data && !error) {
    const today = new Date();
    const end = new Date(today);
    end.setMonth(end.getMonth() + 1); // Default 1 month
    await supabase.from('subscription').insert([{
      email,
      'start date': today.toISOString().split('T')[0],
      duration: 1,
      'end date': end.toISOString().split('T')[0],
      courses: ''
    }]);
  }
}

// --- AUTH ---
function showLoginModal() {
  loginModal.style.display = 'block'
  modalBg.style.display = 'block'
}
function hideLoginModal() {
  loginModal.style.display = 'none'
  modalBg.style.display = 'none'
}
closeModalBtn.onclick = hideLoginModal

loginBtn.onclick = async function() {
  const email = loginEmail.value.trim()
  const password = loginPassword.value.trim()
  if(!email || !password) return alert('Please enter email and password.')

  const { data, error } = await supabase.auth.signInWithPassword({ email, password })
  if (error) return alert('Login failed: ' + error.message)

  currentUser = data.user
  if(!currentUser) return alert('User login failed.')

  // -- Automatically add user's email to subscription if not already there
  await ensureSubscription(currentUser.email);

  statusBar.textContent = `Logged in as ${currentUser.email}`
  hideLoginModal()

  if(currentUser.email === "thrivesarchivers@gmail.com") {
    adminPanel.style.display = 'block'
    fetchSubscriptions()
  } else {
    adminPanel.style.display = 'none'
  }

  fetchVideos()
}

// Auto-login
window.addEventListener('DOMContentLoaded', async () => {
  const { data: { session } } = await supabase.auth.getSession()
  if(session && session.user) {
    currentUser = session.user
    // -- Automatically add user's email to subscription if not already there
    await ensureSubscription(currentUser.email);

    statusBar.textContent = `Logged in as ${currentUser.email}`
    if(currentUser.email === "thrivesarchivers@gmail.com") adminPanel.style.display = 'block'
    fetchVideos()
  } else {
    showLoginModal()
  }
})

// --- VIDEOS ---
async function fetchVideos() {
  const { data, error } = await supabase.from('Videos').select('*').order('order', { ascending: true })
  if (error) { container.innerHTML = "<b>Failed to load videos.</b>"; return }
  allVideos = data
  renderVideos(data)
  if(currentUser && currentUser.email === "thrivesarchivers@gmail.com") renderExistingVideos(data)
}

function renderVideos(videos) {
  let grouped = {}
  videos.forEach(v => {
    let sec = v.section || 'Other'
    let sem = v.semester || 'Other'
    if(!grouped[sec]) grouped[sec] = {}
    if(!grouped[sec][sem]) grouped[sec][sem] = []
    grouped[sec][sem].push(v)
  })

  container.innerHTML = ""
  Object.keys(grouped).forEach(section => {
    let secDiv = document.createElement('div')
    secDiv.className = 'section'
    secDiv.innerHTML = `<h3>${section}</h3>`
    Object.keys(grouped[section]).forEach(semester => {
      let semDiv = document.createElement('div')
      semDiv.innerHTML = `<div class="semester-title">${semester}</div>`
      grouped[section][semester].forEach(video => {
        let vidDiv = document.createElement('div')
        vidDiv.className = 'video-card'
        vidDiv.textContent = video.title
        vidDiv.onclick = ()=> playVideo(video['video id'])
        semDiv.appendChild(vidDiv)
      })
      secDiv.appendChild(semDiv)
    })
    container.appendChild(secDiv)
  })
}

function playVideo(videoId) {
  videoFrame.src = `https://www.youtube.com/embed/${videoId}`
}

// --- ADMIN VIDEO MANAGEMENT ---
function renderExistingVideos(data) {
  existingVideosDiv.innerHTML = '<h4>Existing Videos:</h4>'
  data.forEach(v => {
    const div = document.createElement('div')
    div.style.borderBottom = "1px solid #ccc"
    div.style.marginBottom = "5px"
    div.style.paddingBottom = "5px"
    div.innerHTML = `${v.title} (${v.section} - ${v.semester}) <button class="delete-btn" data-id="${v.id}">Delete</button>`
    existingVideosDiv.appendChild(div)
  })
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.onclick = async () => {
      const id = btn.getAttribute('data-id')
      const { error } = await supabase.from('Videos').delete().eq('id', id)
      if (error) return console.error(error)
      fetchVideos()
    }
  })
}

// Admin: Add Video
addVideoForm.onsubmit = async (e) => {
  e.preventDefault()
  if(!currentUser || currentUser.email !== "thrivesarchivers@gmail.com") return alert("Admins only.")
  const title = document.getElementById('videoTitle').value.trim()
  const video_id = document.getElementById('videoID').value.trim()
  const password_list = document.getElementById('passwordList').value.trim()
  const section = document.getElementById('videoSection').value
  const semester = document.getElementById('videoSemester').value
  const order = parseInt(document.getElementById('videoOrder').value)
  if(!title || !video_id || !section || !semester || isNaN(order)) return alert("Fill all fields.")
  const { error } = await supabase.from('Videos').insert([{ title, 'video id': video_id, 'password list': password_list, section, semester, order }])
  if (error) return alert(error.message)
  addVideoForm.reset()
  fetchVideos()
}

// --- SUBSCRIPTIONS MANAGEMENT ---
async function fetchSubscriptions() {
  const { data, error } = await supabase.from('subscription').select('*')
  if (error) return (subscriptionsAdmin.innerHTML = "Failed to fetch subscriptions.")
  renderSubscriptionsAdmin(data)
}

function renderSubscriptionsAdmin(data) {
  subscriptionsAdmin.innerHTML = `<h4>All Subscriptions</h4>
    <table border="1" style="width:100%;border-collapse:collapse;">
      <tr><th>Email</th><th>Start</th><th>Duration (months)</th><th>End</th><th>Courses</th><th>Action</th></tr>
      ${data.map(sub=>`
       <tr>
         <td>${sub.email}</td>
         <td>${sub['start date']||''}</td>
         <td>${sub.duration||''}</td>
         <td>${sub['end date']||''}</td>
         <td>${sub.courses||'All'}</td>
         <td>
           <button onclick="editSub('${sub.email}')">Edit</button>
           <button style="background:red;" onclick="deleteSub('${sub.email}')">Delete</button>
         </td>
       </tr>`).join('')}
    </table>
    <h4>Add/Update Subscription</h4>
    <form id="addSubForm">
      <input type="email" id="subEmail"placeholder="Email" required>
      <input type="date" id="subStart" placeholder="Start Date" required>
      <select id="subDuration" required>
        <option value="">Select Duration</option>
        <option value="1">1 Month</option>
        <option value="3">3 Months</option>
        <option value="5">5 Months</option>
      </select>
      <input type="text" id="subCourses" placeholder="Courses (comma separated, blank for ALL)">
      <button type="submit">Save Subscription</button>
    </form>
  `;

  // Handle Add/Update Subscription
  document.getElementById('addSubForm').onsubmit = async (e) => {
    e.preventDefault();
    const email = document.getElementById('subEmail').value.trim().toLowerCase();
    const start = document.getElementById('subStart').value;
    const duration = parseInt(document.getElementById('subDuration').value);
    if(!email || !start || !duration) return alert('Fill all required fields.');

    // Calculate end date
    const startDate = new Date(start);
    const endDate = new Date(startDate.setMonth(startDate.getMonth() + duration));
    const endStr = endDate.toISOString().split('T')[0]; // YYYY-MM-DD
    const courses = document.getElementById('subCourses').value.trim();

    const { error } = await supabase.from('subscription').upsert([{
      email,
      'start date': start,
      duration,
      'end date': endStr,
      courses
    }]);
    if (error) return alert("Error: " + error.message);

    fetchSubscriptions();
    alert("Subscription saved/updated!");
    document.getElementById('addSubForm').reset();
  }
}

// Edit existing subscription
window.editSub = function(email) {
  const row = Array.from(subscriptionsAdmin.querySelectorAll('tr'))
    .find(tr => tr.children[0]?.textContent === email);
  if(!row) return;
  document.getElementById('subEmail').value = row.children[0].textContent;
  document.getElementById('subStart').value = row.children[1].textContent;
  document.getElementById('subDuration').value = row.children[2].textContent;
  document.getElementById('subCourses').value = row.children[4].textContent === "All" ? "" : row.children[4].textContent;
}

// Delete subscription
window.deleteSub = async function(email) {
  if(confirm("Delete subscription for " + email + "?")) {
    const { error } = await supabase.from('subscription').delete().eq('email', email);
    if(error) return alert("Error: "+error.message);
    fetchSubscriptions();
  }
}
</script>
</body>
</html>
